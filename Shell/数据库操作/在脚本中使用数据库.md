[toc]

### 1. 登录到服务器

实现的方法有好几种，其中一种是使用 `-p` 选项，在命令行中加入密码：

```shell
mysql mytest -u test -p test
```

不过这并不是一个好做法。所有能够访问你脚本的人都会知道数据库的用户账户和密码。

要解决这个问题，可以借助 mysql 程序所使用的一个特殊配置文件。mysql 程序使用 `$HOME/.my.cnf` 文件来读取特定的启动命令和设置。其中一项设置就是用户启动的 mysql 会话的默认密码。

要想在这个文件中设置默认密码，只需要像下面这样：

```shell
$ cat .my.cnf
[client]
password = test
$ chmod 400 .my.cnf
$
```

现在可以在命令行上测试一下：

```shell
$ mysql -u test 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 9
Server version: 5.7.33-0ubuntu0.16.04.1 (Ubuntu)

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>
```

### 2. 向服务器发送命令

有两种实现方法：

+ 发送单个命令并退出；
+ 发送多个命令。

要发送单个命令，你必须将命令作为 mysql 命令行的一部分。对于 mysql 命令，可以用  `-e` 选项：

```shell
$ cat test.sh 
#!/bin/bash
# send a command to the MySQL server

MYSQL=$(which mysql)
$MYSQL mytest -u root -e 'select * from employees'
$ ./test.sh 
+-------+----------+------------+--------+
| empid | lastname | firstname  | salary |
+-------+----------+------------+--------+
|     1 | Blum     | Rich       |  25000 |
|     2 | Blum     | Barbara    |  45000 |
|     3 | Blum     | Katie Jane |  34500 |
|     4 | Blum     | Jessica    |  52340 |
+-------+----------+------------+--------+
```

如果你需要发送多条 SQL 命令，可以利用文件重定向：

```shell
$ cat test.sh 
#!/bin/bash
# send multiple commands to the MySQL server

MYSQL=$(which mysql)
$MYSQL mytest -u root <<EOF
show tables;
select * from employees where salary > 40000;
EOF
$ ./test.sh 
Tables_in_mytest
employees
empid   lastname        firstname       salary
2       Blum    Barbara 45000
4       Blum    Jessica 52340 
```

shell 会将 `EOF` 分隔符之间的所有内容都重定向给 mysql 命令。

> 说明：当使用输入重定向时，mysql 程序改变了默认的输出风格。mysql 程序检测到了输入时重定向过来的，所以它只返回了原始数据而不是在数据两边加上 ASCII 符号框。这非常有利于提取个别的数据元素。

当然，并不是只能从数据表中提取数据。你可以在脚本中使用任何类型的 SQL 命令，比如 `INSERT` 语句：

```shell
$ cat test.sh 
#!/bin/bash
# send data to the table in the MySQL database

MYSQL=$(which mysql)

if [ $# -ne 4 ]
then
    echo "Usage: mtest3 empid lastname firstname salary"
else
    statement="INSERT INTO employees VALUES ($1, '$2', '$3', '$4')"
    $MYSQL mytest -u root <<EOF
    $statement
EOF
    if [ $? -eq 0 ]
    then
        echo Data successfully added
    else
        echo Problem adding data
    fi
fi
$ ./test.sh 
Usage: mtest3 empid lastname firstname salary
$ ./test.sh 5 Blum Jasper 100000
Data successfully added
```

> 注意：在指定结束字符串时，它必须是该行唯一的内容，并且该行必须以这个字符串开头。如果我们将 EOF 文本缩进以和其余的 `if-then` 缩进对齐，它就不会起作用了。

> 注意：在 `INSERT` 语句里，我们在文本值周围用了单引号，在整个 `INSERT` 语句周围用了双引号。一定不要弄混引用字符串值的引号和定义脚本变量文本的引号。

### 3. 格式化数据

提取数据库数据的第一步是将 `mysql` 命令的输出重定向到一个环境变量中：

```shell
$ cat test.sh
#!/bin/bash
# redirecting SQL output to a variable

MYSQL=$(which mysql)

dbs=$($MYSQL mytest -u root -Bse 'show databases')
for db in $dbs 
do 
    echo $db
$ ./test.sh 
information_schema
mysql
mytest
performance_schema
sys
xiatuan@xiatuan-VirtualBox:~/Desktop$ 
```

`-B` 选项指定 `mysql` 程序工作在批处理模式运行，`-s`（silent）选项用于禁止输出列标题和格式化符号。

`mysql` 程序还支持另外一种叫作可扩展标记语言（XML）的流行格式。对于 `mysql` 程序，可以用 `-X`  命令行选项来输出：

```shell
$ mysql mytest -u root -X -e 'select * from employees where empid = 1'
<?xml version="1.0"?>

<resultset statement="select * from employees where empid = 1
" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <row>
	<field name="empid">1</field>
	<field name="lastname">Blum</field>
	<field name="firstname">Rich</field>
	<field name="salary">25000</field>
  </row>
</resultset>
```

