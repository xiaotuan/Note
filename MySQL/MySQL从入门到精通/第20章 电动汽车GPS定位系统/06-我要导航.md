#### 
  20.2.3 我要导航


导航算法比较复杂，可以使用Google地图或百度地图提供的现成路径规划功能。本系统采用Google地图API。当用户确定开始导航的时候首先调用getLocationProvider()取得现有的Location，以此取得目前所在位置的地理坐标（fromPoint），并获取用户输入的地址坐标（toPoint），然后再调用内置地图程序，路径规划Intent要打开的其实就是URL类型，以Uri.Parse（）传入Google Map路线规划的地址：http://maps.google.com/maps?f=d，表示要使用Google Map的路径规划功能。导航关键代码如下。

&#13;
    public class WayActivity extends MapActivity&#13;
    {&#13;
        protected void onCreate(Bundle savedInstanceState)&#13;
        {&#13;
              super.onCreate(savedInstanceState);&#13;
              setContentView(R.layout.waylayout);&#13;
              String defaultAddress="taipei";&#13;
              mEditText01=(EditText)findViewById(R.id.MapeditText);&#13;
              mEditText01.setText(getGeoByAddress(defaultAddress).toString());&#13;
              /*创建MapView对象*/&#13;
              mMapView01=(MapView)findViewById(R.id.mapview2);&#13;
              mMapController01=mMapView01.getController();&#13;
              /*设置MapView的显示选项（交通）*/&#13;
              mMapView01.setTraffic(true);&#13;
              /*放大的层数*/&#13;
              intZoomLevel=15;&#13;
              mMapController01.setZoom(intZoomLevel);&#13;
        /*创建LocationManager对象取得系统LOCATION服务*/&#13;
        mLocationManager01=(LocationManager)getSystemService(Context.LOCATION_SERVICE);&#13;
              /*&#13;
              * 自定义函数，访问Location Provider，并将之保存在strLocationProvider当中&#13;
              */&#13;
              getLocationProvider();&#13;
              /*传入Location对象，显示于MapView*/&#13;
              fromGeoPoint=getGeoByLocation(mLocation01);&#13;
              refreshMapViewByGeoPoint(fromGeoPoint, mMapView01,intZoomLevel);&#13;
              /*&#13;
              * 创建LocationManager对象，监听 * Location更改时事件，更新MapView&#13;
              */&#13;
              mLocationManager01.requestLocationUpdates&#13;
              (strLocationProvider, 2000, 10, mLocationListener01);&#13;
              mButton01=(Button)findViewById(R.id.btnsetway);&#13;
              mButton01.setOnClickListener(new Button.OnClickListener()&#13;
    {&#13;
          public void onClick(View v)&#13;
          {&#13;
                  if(mEditText01.getText().toString()!="")&#13;
                  {&#13;
                        /*取得User要前往地址的GeoPoint对象*/&#13;
                        toGeoPoint=&#13;
                                      getGeoByAddress(mEditText01.getText().toString());&#13;
                        /*线路规划Intent*/&#13;
                        Intent intent=new Intent();&#13;
                        intent.setAction(android.content.Intent.ACTION_VIEW);&#13;
                        /*传入路径规划所需要的地标地址*/&#13;
                        intent.setData&#13;
                        (&#13;
                                      Uri.parse("http://maps.google.com/maps?f=d&aaddr="+&#13;
                        GeoPointToString(fromGeoPoint)+&#13;
                            "&daddr="+GeoPointToString(toGeoPoint)+&#13;
                            "&h1=cn")&#13;
                          );&#13;
                        startActivity(intent);&#13;
                  }&#13;
          }&#13;
    });&#13;
private final LocationListener mLocationListener01 = new LocationListener()&#13;
{&#13;
    public void onLocationChanged(Location location)&#13;
    {&#13;
          /*当手机收到位置更改时，将location传入getMyLocation*/&#13;
          mLocation01=location;&#13;
          fromGeoPoint=getGeoByLocation(location);&#13;
          refreshMapViewByGeoPoint(fromGeoPoint,mMapView01,intZoomLevel);&#13;
    }&#13;
    public void onProviderDisabled(String provider)&#13;
    {&#13;
          mLocation01=null;&#13;
    }&#13;
};&#13;
/*传入Location对象，取回其GeoPoint对象*/&#13;
private GeoPoint getGeoByLocation(Location location) {&#13;
    GeoPoint gp=null;&#13;
    try&#13;
    {&#13;
          /*当Location存在*/&#13;
          if(location!=null)&#13;
          {&#13;
                  double geoLatitude=location.getLatitude()*1E6;&#13;
                  double geoLongitude=location.getLongitude()*1E6;&#13;
                  gp=new GeoPoint((int)geoLatitude,(int)geoLongitude);&#13;
          }&#13;
    }&#13;
    catch(Exception e)&#13;
    {&#13;
          e.printStackTrace();&#13;
    }&#13;
    return gp;&#13;
}&#13;
/*输入地址，取得其GeoPoint对象*/&#13;
private GeoPoint getGeoByAddress(String strSearchAddress) {&#13;
    GeoPoint gp=null;&#13;
    try&#13;
    {&#13;
          if(strSearchAddress!="")&#13;
          {&#13;
                  Geocoder mGeocoder01=new Geocoder&#13;
                                (WayActivity.this,Locale.getDefault());&#13;
                  List<Address> lstAddress=mGeocoder01.getFromLocationName&#13;
                                (strSearchAddress,1);&#13;
                  if(!lstAddress.isEmpty())&#13;
                  {&#13;
                        Address adsLocation=lstAddress.get(0);&#13;
                        double geoLatitude=adsLocation.getLatitude()*1E6;&#13;
                        double geoLongitude=adsLocation.getLongitude()*1E6;&#13;
                        gp=new GeoPoint((int)geoLatitude,(int)geoLongitude);&#13;
                  }&#13;
          }&#13;
    }&#13;
    catch(Exception e)&#13;
    {&#13;
          e.printStackTrace();&#13;
    }&#13;
    return gp;&#13;
}&#13;
/*传入geoPoint更新MapView里的Google Map*/&#13;
private void refreshMapViewByGeoPoint(GeoPoint gp,&#13;
    MapView mapview, int zoomLevel) {&#13;
try&#13;
{&#13;
    mapview.displayZoomControls(true);&#13;
    MapController myMC=mapview.getController();&#13;
    myMC.animateTo(gp);&#13;
    myMC.setZoom(zoomLevel);&#13;
    mapview.setSatellite(false);&#13;
}&#13;
catch(Exception e)&#13;
{&#13;
    e.printStackTrace();&#13;
}&#13;
}&#13;
/*传入经纬度更新MapView里的Google Map*/&#13;
public static void refreshMapViewByCode&#13;
(double latitude, double longitude,&#13;
    MapView mapview, int zoomLevel)&#13;
{&#13;
try&#13;
{&#13;
    GeoPoint p=new GeoPoint((int)latitude,(int)longitude);&#13;
    mapview.displayZoomControls(true);&#13;
    MapController myMC=mapview.getController();&#13;
    myMC.animateTo(p);&#13;
    myMC.setZoom(zoomLevel);&#13;
    mapview.setSatellite(false);&#13;
}&#13;
catch(Exception e)&#13;
{&#13;
    e.printStackTrace();&#13;
}&#13;
}&#13;
/*将GeoPoint里的经纬度以String，String返回*/&#13;
private String GeoPointToString(GeoPoint gp) {&#13;
// TODO Auto-generated method stub&#13;
String strReturn="";&#13;
try&#13;
{&#13;
    /*当Location存在*/&#13;
    if(gp!=null)&#13;
    {&#13;
          double geoLatitude=gp.getLatitudeE6()/1E6;&#13;
    double geoLongitude=gp.getLongitudeE6()/1E6;&#13;
    strReturn=String.valueOf(geoLatitude)+","+&#13;
    String.valueOf(geoLongitude);&#13;
}&#13;
}&#13;
catch(Exception e)&#13;
{&#13;
e.printStackTrace();&#13;
}&#13;
return strReturn;&#13;
}&#13;
/*取得LocationProvider*/&#13;
private void getLocationProvider() {&#13;
try&#13;
{&#13;
Criteria mCriteria01=new Criteria();&#13;
mCriteria01.setAccuracy(Criteria.ACCURACY_FINE);&#13;
mCriteria01.setAltitudeRequired(false);&#13;
mCriteria01.setBearingRequired(false);&#13;
mCriteria01.setCostAllowed(true);&#13;
mCriteria01.setPowerRequirement(Criteria.POWER_LOW);&#13;
strLocationProvider=&#13;
          mLocationManager01.getBestProvider(mCriteria01,true);&#13;
mLocation01=mLocationManager01.getLastKnownLocation(strLocationProvider);&#13;
}&#13;
catch(Exception e)&#13;
{&#13;
mTextView01.setText(e.toString());&#13;
e.printStackTrace();&#13;
}&#13;
}&#13;
｝&#13;

