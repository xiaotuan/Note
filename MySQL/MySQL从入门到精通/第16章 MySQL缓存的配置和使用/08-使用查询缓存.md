#### 
  16.2.2 使用查询缓存


如果query_cache_type设置的是ON⑴或者DEMAND⑵，那么用户在进行查询的时候，服务器会自动缓存查询结果。

在查询的时候有两个查询选项可以使用，分别是SQL_CACHE和SQL_NO_CACHE。其中SQL_CACHE选项表示使用查询缓存，SQL_NO_CACHE表示不使用查询缓存，示例如下。

&#13;
    01 SELECT SQL_CACHE课程名FROM KC;&#13;
    02 SELECT SQL_NO_CACHE课程名FROM KC;&#13;

第01句表是使用查询结果缓存，第02句表示不使用查询结果缓存。

下面是使用查询缓存的过程。

&#13;
    001 mysql>show databases;&#13;
    002 +--------------------+&#13;
    003 |Database        |&#13;
    004 +--------------------+&#13;
    005 |information_schema|&#13;
    006 |mysql       |&#13;
    007 |performance_schema|&#13;
    008 |test       |&#13;
    009 |xscj       |&#13;
    010 +--------------------+&#13;
    011 5 rows in set&#13;
    012 mysql>use xscj;--选中xscj数据库&#13;
    013 Database changed&#13;
    014 mysql>show tables;&#13;
    015 +----------------+&#13;
    016 |Tables_in_xscj|&#13;
    017 +----------------+&#13;
    018 |kc      |&#13;
    019 |xs      |&#13;
    020 |xs_kc     |&#13;
    021 |xs_kc_st   |&#13;
    022 +----------------+&#13;
    023 4 rows in set&#13;
    024 mysql>show variables like'%query_cache%';--查看缓存是否可用&#13;
    025 +------------------------------+---------+&#13;
    026 |Variable_name        |Value |&#13;
    027 +------------------------------+---------+&#13;
    028 |have_query_cache       |YES  |&#13;
    029 |query_cache_limit      |1048576|&#13;
    030 |query_cache_min_res_unit  |4096  |&#13;
    031 |query_cache_size      |0    |&#13;
    032 |query_cache_type       |ON    |&#13;
    033 |query_cache_wlock_invalidate|OFF  |&#13;
    034 +------------------------------+---------+&#13;
    035 6 rows in set&#13;
    036&#13;
    037 mysql>set global query_cache_size=50000;--设置缓存大小&#13;
    038 Query OK,0 rows affected&#13;
    039 mysql>show variables like'%query_cache%';&#13;
    040 +------------------------------+---------+&#13;
    041 |Variable_name        |Value |&#13;
    042 +------------------------------+---------+&#13;
    043 |have_query_cache       |YES  |&#13;
    044 |query_cache_limit      |1048576|&#13;
    045 |query_cache_min_res_unit  |4096  |&#13;
    046 |query_cache_size      |499712 |&#13;
    047 |query_cache_type       |ON    |&#13;
    048 |query_cache_wlock_invalidate|OFF  |&#13;
    049 +------------------------------+---------+&#13;
    050 6 rows in set&#13;
    051 mysql>select*from kc;--第一次查询，建立查询结果缓存&#13;
    052 +--------+----------------+----------+------+------+&#13;
    053 |课程号|课程名    |开课学期|学时|学分|&#13;
    054 +--------+----------------+----------+------+------+&#13;
    055 |101  |计算机基础  |       1| 80|  5|&#13;
    056 |102  |程序设计与语言|       2| 68|  4|&#13;
    057 |206  |离散数学   |        4| 68|  4|&#13;
    058 |208  |数据结构   |        5| 68|  4|&#13;
    059 |209  |操作系统   |        6| 68|  4|&#13;
    060 |210  |计算机原理  |       5| 85|  5|&#13;
    061 |212  |数据库原理  |       7| 68|  4|&#13;
    062 |301  |计算机网络  |       7| 51|  3|&#13;
    063 |302  |软件工程   |        7| 51|  3|&#13;
    064 +--------+----------------+----------+------+------+&#13;
    065 9 rows in set&#13;
    066 mysql>show status like'qcache_hits';--命中率为0&#13;
    067 +---------------+-------+&#13;
    068 |Variable_name|Value|&#13;
    069 +---------------+-------+&#13;
    070 |Qcache_hits |0  |&#13;
    071 +---------------+-------+&#13;
    072 1 row in set&#13;
    073 mysql>select*from kc;--第二次输入同样的查询&#13;
    074 +--------+----------------+----------+------+------+&#13;
    075 |课程号|课程名    |开课学期|学时|学分|&#13;
    076 +--------+----------------+----------+------+------+&#13;
    077 |101  |计算机基础  |       1| 80|  5|&#13;
    078 |102  |程序设计与语言|       2| 68|  4|&#13;
    079 |206  |离散数学   |        4| 68|  4|&#13;
    080 |208  |数据结构   |        5| 68|  4|&#13;
    081 |209  |操作系统   |        6| 68|  4|&#13;
    082 |210  |计算机原理  |       5| 85|  5|&#13;
    083 |212  |数据库原理  |       7| 68|  4|&#13;
    084 |301  |计算机网络  |       7| 51|  3|&#13;
    085 |302  |软件工程   |        7| 51|  3|&#13;
    086 +--------+----------------+----------+------+------+&#13;
    087 9 rows in set&#13;
    088&#13;
    089 mysql>show status like'qcache_hits';--命中率为1，缓存生效&#13;
    090 +---------------+-------+&#13;
    091 |Variable_name|Value|&#13;
    092 +---------------+-------+&#13;
    093 |Qcache_hits |1  |&#13;
    094 +---------------+-------+&#13;
    095 1 row in set&#13;
    096 mysql>select sql_no_cache*from kc;--不使用缓存&#13;
    097 +--------+----------------+----------+------+------+&#13;
    098 |课程号|课程名    |开课学期|学时|学分|&#13;
    099 +--------+----------------+----------+------+------+&#13;
    100 |101  |计算机基础  |    1| 80|    5|&#13;
    101 |102  |程序设计与语言|     2| 68|  4|&#13;
    102 |206  |离散数学   |    4| 68|  4|&#13;
    103 |208  |数据结构   |    5| 68|  4|&#13;
    104 |209  |操作系统   |    6| 68|  4|&#13;
    105 |210  |计算机原理  |    5| 85|    5|&#13;
    106 |212  |数据库原理  |    7| 68|    4|&#13;
    107 |301  |计算机网络  |    7| 51|    3|&#13;
    108 |302  |软件工程   |    7| 51|  3|&#13;
    109 +--------+----------------+----------+------+------+&#13;
    110 9 rows in set&#13;
    111&#13;
    112 mysql>show status like'qcache_hits';--命中率不变，还是1&#13;
    113 +---------------+-------+&#13;
    114 |Variable_name|Value|&#13;
    115 +---------------+-------+&#13;
    116 |Qcache_hits |1  |&#13;
    117 +---------------+-------+&#13;
    118 1 row in set&#13;
    119 mysql>insert into kc values('304','嵌入式软件开发技术1',7,64,4);--插入一条记录，缓存被清除&#13;
    120 Query OK,1 row affected&#13;
    121&#13;
    122 mysql>select*from kc;--再次发送同样的查询&#13;
    123 +--------+---------------------+----------+------+------+&#13;
    124 |课程号|课程名       |开课学期|学时|学分|&#13;
    125 +--------+---------------------+----------+------+------+&#13;
    126 |101  |计算机基础     |    1| 80|  5|&#13;
    127 |102  |程序设计与语言   |    2| 68|  4|&#13;
    128 |206  |离散数学      |     4| 68|  4|&#13;
    129 |208  |数据结构      |     5| 68|  4|&#13;
    130 |209  |操作系统      |     6| 68|  4|&#13;
    131 |210  |计算机原理     |    5| 85|  5|&#13;
    132 |212  |数据库原理     |    7| 68|  4|&#13;
    133 |301  |计算机网络     |    7| 51|  3|&#13;
    134 |302  |软件工程      |     7| 51|  3|&#13;
    135 |303  |嵌入式软件开发技术 |    7| 64|  4|&#13;
    136 |304  |嵌入式软件开发技术1|        7| 64|  4|&#13;
    137 +--------+---------------------+----------+------+------+&#13;
    138 11 rows in set&#13;
    139&#13;
    140 mysql>show status like'%qcache_hits%';--命中率不变&#13;
    141 +---------------+-------+&#13;
    142 |Variable_name|Value|&#13;
    143 +---------------+-------+&#13;
    144 |Qcache_hits |1  |&#13;
    145 +---------------+-------+&#13;
    146 1 row in set&#13;

