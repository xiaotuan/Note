###### 十三、TCP的特点和报文结构

**1、面向连接、可靠传输、面向字节流、全双工服务**

**2、TCP的报文结构**

TCP报文段由**首部字段**和一个**数据字段**组成。
数据字段包含一块应用数据。最大报文长度`MSS`（Maximum Segment Size）限制了报文段数据字段的最大长度。`MSS`选项用于在TCP连接建立时，收发双方协商通信时每一个报文段所能承载的最大数据长度。
所以当TCP发送一个大文件（比如一张高清图片）时，通常是将该文件划分为`MSS`长度的若干块（最后一块除外，通常会小于`MSS`）。而实际交互式应用通常传送长度小于`MSS`的数据块。

如图，与UDP一样，首部包括**源端口号**和**目的端口号**，用于多路复用/分解来自上层或送到上层应用的数据。TCP首部也同样包括**检验和字段**

TCP首部还包含下列字段:

* 32比特的**序号字段Seq(sequence number field)** 和32比特的**确认号字段Ack(acknowledge number field)**

* 16比特的**接收窗口字段RW(receive window field)**,该字段用于流量控制，用于指示接收方愿意接收的字节数量。
* 4比特的**首部长度字段（header length field）**，该字段指示了以32比特的字为单位的TCP首部长度。由于TCP选项字段的原因，TCP首部长度是可变的。（通常，选项字段为空，所以TCP首部的典型长度就是20字节）
* 可选和变长的**选项字段（option field）**，该字段用于发送方和接收方协商最大报文段长度（MSS）时，或用作窗口调节因子时使用。
* 6比特的**标志字段（flag field）**。ACK比特用于指示确认字段中的值是有效的，即该报文段包括一个对已被接收报文段的确认。**RST、SYN、FIN**比特用于连接建立和拆除。
**PSH**比特指示接收方应立即将数据交给上层。**URG**比特用于指示报文段里存在着被发送端的上层实体置为“紧急”的数据。紧急数据的最后一个字节由16比特的紧急数据指针字段指出。当紧急数据存在并给出指向紧急数据尾的指针的时候，TCP必须通知接收端的上层实体。在实践中，PSH、URG和紧急数据指针并没有使用。


**3、序号字段Seq和确认号字段Ack**

* 在TCP通讯中，无论是建立连接，数据传输，友好断开，强制断开，都离不开Seq值和Ack值，它们是TCP传输的可靠保证。

**序号Seq**：
TCP把数据看成一个无结构的、有序的字节流。一个**报文段的序号**因此是该报文段的首字节的字节流编号。
比如数据流由一个包含`100000`字节的文件组成，其`MSS`是`1000`字节，数据流的首字节编号是0。该TCP将为该数据流构建`100`个报文段。给第一个报文段分配序号0，第二个则是`1000`，第三个是`2000`，以此类推。每一个序号被填入到相应TCP报文段首部的序号字段中。

**确认号Ack：**
TCP是全双工服务的，因此主机A在向主机B发送数据的同时，也许也在接收主机B的数据。
主机A填充进报文段的确认号是主机A期望从主机B收到的下一个字节的序号。

在上个例子中，假如服务端已经接收包含字节`0-999`的报文段和包含字节`2000-2999`的报文段，但由于某种原因，还未收到包含字节`1000-1999`的报文段，那么将仍会等待字节`1000`（及其后的字节）。因此服务端发给客户端的下一个报文段将在**确认号Ack**字段中包含1000。
因为TCP只确认该流中至第一个丢失字节为止的字节，所以TCP被称为**累积确认**。
