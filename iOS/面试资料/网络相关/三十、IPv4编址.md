###### 三十、IPv4编址

**1、IP地址**

一台主机通常只有一条链路连接到网络，当主机上的IP想发送一条数据报时，就在该链路上发送。主机与物理链路之间的边界叫做**接口（interface）**。
而路由器的任务是从链路上接收数据报并从某些其他链路转发出去，路由器必须有两条或更多链路与其连接，路由器与它的任意一条链路之间的边界也叫做`接口`。即一台路由器会有多个`接口`，每个`接口`有其链路。
因为每台主机与路由器都能发送和接收IP数据报，IP要求每台主机和路由器`接口`都有自己的IP地址。因此，一个IP地址技术上是与一个`接口`相关联的，而不是与包括该接口的主机或路由器相关联的。

**2、子网**

每个IP地址（IPv4）长度为32比特（4字节），按**点分十进制记法**书写，即地址中的每个字节都用它的十进制形式书写，各字节间以点.隔开，比如`193.32.122.30`
在因特网上的每台主机和路由器上的每个接口，必须有一个全球唯一的IP地址（NAT后的接口除外）。这些地址不能自由选择，一个接口的IP地址的一部分需要由其连接的子网来决定。

**3、无类别域间路由选择（CIDR）**

因特网的地址分配策略被称为**无类别域间路由选择（CIDR）**(也被称为`无分类编址`，以区分于`分类编址`)。对于子网寻址，32比特的IP地址被分为两部分，也是点分十进制数形式`a.b.c.d/x`，其中x指示了地址的第一部分中的比特数，又被称为该地址的**前缀（prefix）**。
一个组织通常被分配一块连续的地址，即具有相同前缀的地址。在该组织外的的路由器仅考虑前面的前缀比特x，这相当大地减少了在这些路由器中转发表的长度，形式为`a.b.c.d/x`单一表项足以将数据报转发到该组织内的任何目的地。

**4、分类编址**

在CIDR被采用之前，IP地址的网络部分被限制长度为8、16、24比特，也就是**分类编址（classful addressing）**。具有8、16、24比特子网地址的子网被称为`A、B`和`C`类网络。
一个`C类（/24）`子网既能容纳**2的八次方 - 2 = 254**台主机（其中两个地址预留用于特殊用途），这对于很多组织来说都太小了。
而一个`B类（/16）`子网可支持多达**2的16次方 - 2 = 65534**台主机，又太大了。
在分类编址方法下，一个有`2000`台主机的组织通常被分给一个B类（/16）地址，那么剩下的6万多个地址就浪费掉了。这就会导致**B类地址空间的迅速损耗以及所分配的地址空间的利用率低**。

此外，`255.255.255.255`是IP广播地址，当一台主机发出一个目的地址为该地址的数据报时，该报文会交付给同一个网络中的所有主机。

**5、获取主机地址**

某组织一旦获得了一块地址，它就可为本组织内的主机与路由器逐一分配IP地址。系统管理员通常手工配置路由器中的IP地址。主机地址也能手动配置，但更多使用的是**动态主机配置协议（DHCP）**。DHCP允许主机自动获取IP地址。网络管理员可以配置DHCP，以使某给定主机每次与网络连接时能得到一个相同的IP地址，或者某主机将被分配一个**临时的IP地址**，该地址在每次与网络连接时也许是不同的。

**6、网络地址转换**

每个IP地址（IPv4）长度为32比特（4字节），因此总共有`2的32次方`个可能的IP地址，约为40亿个。在互联网越来越普及的当下，个人计算机及智能手机等越来越多，这些IP地址显然无法满足人们的需求。
为了解决IP地址不足的问题，于是就有了**网络地址转换(Network Address Translation， NAT)**，它的思想就是给一个局域网络分配一个IP地址就够了，对于这个网络内的主机，则分配私有地址，这些私有地址对外是不可见的，他们对外的通信都要借助那个唯一分配的IP地址。

如果从广域网到达`NAT路由器`的所有数据报都有相同的目的IP地址，那么该路由器如何知道是发送给哪个内部主机的呢？其原理就是使用在NAT路由器上的一张**NAT转换表**，并在该表内包含了端口号及其IP地址。

> 假设一台主机向广域网请求数据，NAT路由器收到该数据报，会为该数据报生成一个新的端口号替换掉源端口号，并将源IP替换为其广域网一侧接口的IP地址。当生成一个新的源端口号时，该端口号可以是任意一个当前未在NAT转换表中的源端口号（端口号字段是16比特，意味着NAT协议可以支持超过60000个并行使用路由器广域网一侧IP地址的连接），路由器中的NAT也在其NAT转换表中增加一表项。
> 
> 该NAT路由器收到广域网返回的数据时，路由器使用目的IP地址与目的端口号从NAT转换表中检索出该主机使用的IP地址和目的端口号，改写该数据报的目的IP地址和目的端口号，并向该主机转发该数据报

NAT虽然在近几年得到了很广泛的应用，但也被很多人反对。
主要是：

> * 1、端口号是用来进程编址的，而不是主机编址的（NAT协议类似 NAT路由器将该家庭网络的主机都当做进程处理，并通过NAT转换表为其分配端口号）
> * 2、路由器通常仅应当处理高达第三层的分组
> * 3、违背端到端原则，即主机彼此之间应当相互直接对话，结点不应当介入修改IP地址与端口号。
> * 4、应当用IPv6来解决IP地址短缺问题

但不管反对与否，NAT终究已成为当今因特网的一个重要组件

