[toc]

#è®¾ç½®æŸ¥è¯¢æ¡ä»¶

æ‰§è¡Œä¸‹é¢`NSManagedObjectContext`çš„`fetchRequest`æ–¹æ³•ï¼Œä¸€èˆ¬éƒ½éœ€è¦ä¼ å…¥ä¸€ä¸ª`NSFetchRequest`ç±»å‹çš„å‚æ•°ã€‚è¿™ä¸ª`requet`å‚æ•°å¯ä»¥åšä¸€äº›è®¾ç½®æ“ä½œï¼Œè¿™æ ·å°±å¯ä»¥ä»¥è¾ƒä¼˜çš„æ€§èƒ½è·å–æŒ‡å®šçš„æ•°æ®ã€‚

```Objective-C
- (nullable NSArray *)executeFetchRequest:(NSFetchRequest *)request error:(NSError **)error;
```

##1.1 NSFetchRequest

åœ¨æ‰§è¡Œ`fetch`æ“ä½œå‰ï¼Œå¯ä»¥ç»™`NSFetchRequest`è®¾ç½®ä¸€äº›å‚æ•°ï¼Œè¿™äº›å‚æ•°åŒ…æ‹¬è°“è¯ã€æ’åºç­‰æ¡ä»¶ä¸‹ï¼Œä¸‹é¢æ˜¯ä¸€äº›åŸºç¡€çš„è®¾ç½®ã€‚

+ è®¾ç½®æŸ¥æ‰¾å“ªä¸ªå®ä½“ï¼Œä»æ•°æ®åº“çš„è§’åº¦æ¥çœ‹å°±æ˜¯æŸ¥æ‰¾å“ªå¼ è¡¨ï¼Œé€šè¿‡`fetchRequestWithEntityName:`æˆ–åˆå§‹åŒ–æ–¹æ³•æ¥æŒ‡å®šè¡¨åã€‚
+ é€šè¿‡`NSPredicate`ç±»å‹çš„å±æ€§ï¼Œå¯ä»¥è®¾ç½®æŸ¥æ‰¾æ¡ä»¶ï¼Œè¿™ä¸ªå±æ€§åœ¨å¼€å‘ä¸­ç”¨å¾—æœ€å¤šã€‚`NSPredicate`å¯ä»¥åŒ…æ‹¬å›ºå®šæ ¼å¼çš„æ¡ä»¶ä»¥åŠ**æ­£åˆ™è¡¨è¾¾å¼**ã€‚
+ é€šè¿‡ `sortDescriptors` å±æ€§ï¼Œå¯ä»¥è®¾ç½®è·å–ç»“æœæ•°ç»„çš„æ’åºæ–¹å¼ï¼Œè¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯**å¯ä»¥è®¾ç½®å¤šç§æ’åºæ¡ä»¶ã€‚**ï¼ˆä½†æ˜¯æ³¨æ„æ¡ä»¶ä¸è¦å†²çªï¼‰
+ é€šè¿‡ `fetchOffset` å±æ€§è®¾ç½®ä»æŸ¥è¯¢ç»“æœçš„ç¬¬å‡ ä¸ªå¼€å§‹è·å–ï¼Œé€šè¿‡ `fetchLimit` å±æ€§è®¾ç½®æ¯æ¬¡è·å–å¤šå°‘ä¸ªã€‚ä¸»è¦ç”¨äºåˆ†é¡µæŸ¥è¯¢ã€‚

`NSManagedObjectContext` æ‰§è¡Œ `fetch`æ“ä½œåï¼Œè·å–çš„ç»“æœæ˜¯ä»¥æ•°ç»„çš„å½¢å¼å­˜å‚¨çš„ï¼Œæ•°ç»„ä¸­å­˜å‚¨çš„å°±æ˜¯æ‰˜ç®¡å¯¹è±¡ã€‚`NSFetchRequest` æä¾›äº†å‚æ•° `resultType`ï¼Œå‚æ•°ç±»å‹æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ã€‚é€šè¿‡è¿™ä¸ªå‚æ•°ï¼Œå¯ä»¥è®¾ç½®æ‰§è¡Œ `fetch` æ“ä½œåè¿”å›çš„æ•°æ®ç±»å‹ã€‚

+ **NSManagedObjectResultTypeï¼š**è¿”å›å€¼æ˜¯ `NSManagedObject` çš„å­ç±»ï¼Œä¹Ÿå°±æ˜¯æ‰˜ç®¡å¯¹è±¡ï¼Œè¿™æ˜¯é»˜è®¤é€‰é¡¹ã€‚
+ **NSManagedObjectIDResultTypeï¼š**è¿”å› `NSManagedObjectID` ç±»å‹çš„å¯¹è±¡ï¼Œä¹Ÿå°± `NSManagedObject` çš„ `ID`ï¼Œå¯¹å†…å­˜å ç”¨æ¯”è¾ƒå°ã€‚`NSManagedObjectContext` å¯ä»¥é€šè¿‡ `NSManagedObjectID` å¯¹è±¡è·å–å¯¹åº”çš„æ‰˜ç®¡å¯¹è±¡ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç¼“å­˜ `NSManagedObjectID` å‚æ•°æ¥èŠ‚çœå†…å­˜æ¶ˆè€—ã€‚
+ **NSDictionaryResultTypeï¼š**è¿”å›å­—å…¸ç±»å‹å¯¹è±¡ã€‚
+ **NSCountResultTypeï¼š**è¿”å›è¯·æ±‚ç»“æœçš„ `count` å€¼ï¼Œè¿™ä¸ªæ“ä½œæ˜¯å‘ç”Ÿåœ¨æ•°æ®åº“å±‚çº§çš„ï¼Œå¹¶ä¸éœ€è¦å°†æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚

##1.2 è®¾ç½®è·å–æ¡ä»¶

```Objective-C
// å»ºç«‹è·å–æ•°æ®çš„è¯·æ±‚å¯¹è±¡ï¼Œå¹¶æŒ‡æ˜æ“ä½œEmployeeè¡¨
NSFetchRequest *request = [NSFetchRequest fetchRequestWithEntityName:@"Employee"];

// è®¾ç½®è¯·æ±‚æ¡ä»¶ï¼Œé€šè¿‡è®¾ç½®çš„æ¡ä»¶ï¼Œæ¥è¿‡è™‘å‡ºéœ€è¦çš„æ•°æ®
NSPredicate *predicate = [NSPredicate predicateWithFormat:@"name = %@", @"lxz"];
request.predicate = predicate;

// è®¾ç½®è¯·æ±‚ç»“æœæ’åºæ–¹å¼ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªæˆ–ä¸€ç»„æ’åºæ–¹å¼ï¼Œæœ€åå°†æ‰€æœ‰çš„æ’åºæ–¹å¼æ·»åŠ åˆ°æ’åºæ•°ç»„ä¸­
NSSortDescriptor *sort = [NSSortDescriptor sortDescriptorWithKey:@"height" ascending:YES];
// NSSortDescriptorçš„æ“ä½œéƒ½æ˜¯åœ¨SQLiteå±‚çº§å®Œæˆçš„ï¼Œä¸ä¼šå°†å¯¹è±¡åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ‰€ä»¥å¯¹å†…å­˜çš„æ¶ˆè€—éå¸¸å°çš„
request.sortDescriptors = @[sort];

// æ‰§è¡Œè·å–è¯·æ±‚æ“ä½œï¼Œè·å–çš„æ‰˜ç®¡å¯¹è±¡å°†ä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ªæ•°ç»„ä¸­å¹¶è¿”å›
NSError *error = nil;
NSArray<Employee *> *employees = [context executeFetchRequest:request error:&error];
[employees enumerateObjectsUsingBlock:^(Employee * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
    NSLog(@"Employee Name: %@, Height: %f, Birthday: %@", obj.name, obj.height, obj.brithday);
}];

// é”™è¯¯å¤„ç†
if (error) {
    NSLog(@"CoreData Fetch Data Error: %@", error);
}
```

è¿™é‡Œè®¾ç½® `NSFetchRequest` å¯¹è±¡çš„ä¸€äº›è¯·æ±‚æ¡ä»¶ï¼Œè®¾ç½®æŸ¥æ‰¾ `Employee` è¡¨ä¸­ `name` ä¸º `lxz` çš„æ•°æ®ï¼Œå¹¶ä¸”å°†æ‰€æœ‰ç¬¦åˆçš„æ•°æ®ç”¨ `height` å€¼**å‡åº**çš„æ–¹æ³•æ’åˆ—ã€‚

##1.3 æœ‰å®ä½“å…³è”å…³ç³»

ä¸€ä¸ªæ¨¡å‹æ–‡ä»¶ä¸­çš„ä¸åŒå®ä½“é—´ï¼Œå¯ä»¥è®¾ç½®å®ä½“é—´çš„å…³è”å…³ç³»ï¼Œè¿™ä¸ªåœ¨ä¹‹å‰çš„æ–‡ç« ä¸­è®²è¿‡ã€‚å®ä½“å…³è”å…³ç³»åˆ†ä¸º**ä¸€å¯¹ä¸€**æˆ–**ä¸€å¯¹å¤š**ï¼Œä¹Ÿå¯ä»¥è®¾ç½®æ˜¯å¦**åŒå‘å…³è”**ã€‚

è¿™é‡Œæ¼”ç¤ºçš„å®ä½“åªæ˜¯ç®€å•çš„ `To One` çš„å…³ç³»ï¼Œå¹¶ä¸”ä¸‹é¢ä¼šç»™å‡ºè®¾ç½®æ˜¯å¦åŒå‘å…³è”çš„åŒºåˆ«å¯¹æ¯”ã€‚

###1.3.1 æ’å…¥å®ä½“

```Objective-C
// åˆ›å»ºæ‰˜ç®¡å¯¹è±¡ï¼Œå¹¶å°†å…¶å…³è”åˆ°æŒ‡å®šçš„MOCä¸Š
Employee *zsEmployee = [NSEntityDescription insertNewObjectForEntityForName:@"Employee" inManagedObjectContext:context];
zsEmployee.name = @"zhangsan";
zsEmployee.height = 1.9f;
zsEmployee.brithday = [NSDate date];

Employee *lsEmployee = [NSEntityDescription insertNewObjectForEntityForName:@"Employee" inManagedObjectContext:context];
lsEmployee.name = @"lisi";
lsEmployee.height = 1.7f;
lsEmployee.brithday = [NSDate date];

Department *iosDepartment = [NSEntityDescription insertNewObjectForEntityForName:@"Department" inManagedObjectContext:context];
iosDepartment.departName = @"iOS";
iosDepartment.createDate = [NSDate date];
iosDepartment.employee = zsEmployee;

Department *androidDepartment = [NSEntityDescription insertNewObjectForEntityForName:@"Department" inManagedObjectContext:context];
androidDepartment.departName = @"android";
androidDepartment.createDate = [NSDate date];
androidDepartment.employee = lsEmployee;

// æ‰§è¡Œå­˜å‚¨æ“ä½œ
NSError *error = nil;
if (context.hasChanges) {
    [context save:&error];
}

// é”™è¯¯å¤„ç†
if (error) {
    NSLog(@"Association Table add Data Error: %@", error);
}
```

å¯ä»¥çœ‹åˆ°ä¸Šé¢æ‰€æœ‰çš„æ‰˜ç®¡å¯¹è±¡åˆ›å»ºæ—¶ï¼Œéƒ½ä½¿ç”¨ `NSEntityDescription` çš„ `insert` æ–¹æ³•åˆ›å»ºï¼Œ**å¹¶å’Œä¸Šä¸‹æ–‡å»ºç«‹å…³ç³»**ã€‚è¿™æ—¶å°±æƒ³é—®äº†ï¼Œæˆ‘èƒ½ç›´æ¥é‡‡ç”¨ä¼ ç»Ÿçš„ `init` æ–¹æ³•åˆ›å»ºå—ï¼Ÿ

**ä¼šå´©çš„ğŸ˜±ï¼åˆ›å»ºæ‰˜ç®¡å¯¹è±¡æ—¶éœ€è¦æŒ‡å®šNSManagedObjectContext**ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€çš„ç”Ÿæˆ `set`ã€`get` æ–¹æ³•ã€‚ä½†æ˜¯ç›´æ¥é€šè¿‡ `init` æ–¹æ³•åˆå§‹åŒ–çš„å¯¹è±¡ï¼Œç³»ç»Ÿæ˜¯ä¸çŸ¥é“è¿™é‡Œæ˜¯éœ€è¦ç³»ç»Ÿè‡ªèº«ç”Ÿæˆ `set`ã€`get`æ–¹æ³•çš„ï¼Œè€Œä¸”ç³»ç»Ÿä¹Ÿä¸çŸ¥é“åº”è¯¥å¯¹åº”å“ªä¸ª `NSManagedObjectContext`ï¼Œä¼šå¯¼è‡´æ–¹æ³•æœªå®ç°çš„å´©æºƒã€‚æ‰€ä»¥å°±å‡ºç°äº†å¼€å‘ä¸­ç»å¸¸å‡ºç°çš„é”™è¯¯ï¼Œå¦‚ä¸‹é¢å´©æºƒä¿¡æ¯ï¼š

```
- [Employee setName:]: unrecognized selector sent to instance 0x7fa665900f60
```

###1.3.2 åŒå‘å…³è”

åœ¨æ‰‹åŠ¨å‘é¡¹ç›®ä¸­æ·»åŠ CoreDataçš„æ–‡ç« ä¸­æåˆ°è¿‡åŒå‘å…³è”çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯è®¾ç½® `Relationship` æ—¶ `Inverse` æ˜¯å¦ä¸ºç©ºã€‚ä¸‹é¢æ˜¯ `Employee` å’Œ `Department` åœ¨æ•°æ®åº“ä¸­ï¼Œè®¾ç½® `inverse` å’Œæ²¡æœ‰è®¾ç½® `inverse` çš„ä¸¤ç§æ•°æ®å­˜å‚¨ï¼Œå¯ä»¥å¾ˆæ¸…æ™°çš„å¯¹æ¯”å‡ºè®¾ç½®åŒå‘å…³è”çš„åŒºåˆ«ã€‚
æµ‹è¯•ä»£ç è¿˜æ˜¯ç”¨ä¸Šé¢æ’å…¥å®ä½“çš„ä»£ç ï¼Œåªæ˜¯æ›´æ”¹ `inverse` é€‰é¡¹ã€‚

**è®¾ç½®åŒå‘å…³è”**

![20](./images/20.jpg)

![21](./images/21.jpg)

**æœªè®¾ç½®åŒå‘å…³è”**

![22](./images/22.jpg)

![23](./images/23.jpg)

ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæœªè®¾ç½®åŒå‘å…³è”çš„å®ä½“ï¼Œ`Department` å…³è” `Employee` ä¸ºå±æ€§å¹¶å­˜å‚¨åï¼Œ`Department`è¡¨ä¸­çš„å…³ç³»æ˜¯å­˜åœ¨çš„ï¼Œä½† `Employee`è¡¨ä¸­çš„å…³ç³»ä¾ç„¶æ˜¯ç©ºçš„ã€‚è€Œè®¾ç½®åŒå‘å…³è”åçš„å®ä½“ï¼Œåœ¨ `Department` å…³è” `Employee` ä¸ºå±æ€§å¹¶å­˜å‚¨åï¼Œ`Employee`åœ¨è¡¨ä¸­è‡ªåŠ¨è®¾ç½®äº†å’Œ `Department`çš„å…³ç³»ã€‚

###1.3.3 æŸ¥è¯¢æ“ä½œ

```Objective-C
// åˆ›å»ºè·å–æ•°æ®çš„è¯·æ±‚å¯¹è±¡ï¼Œå¹¶æŒ‡æ˜æ“ä½œDepartmentè¡¨
NSFetchRequest *request = [NSFetchRequest fetchRequestWithEntityName:@"Department"];

// è®¾ç½®è¯·æ±‚æ¡ä»¶ï¼Œè®¾ç½®employeeçš„nameä¸ºè¯·æ±‚æ¡ä»¶ã€‚NSPredicateçš„å¥½å¤„åœ¨äºï¼Œå¯ä»¥è®¾ç½®keyPathæ¡ä»¶
NSPredicate *predicate = [NSPredicate predicateWithFormat:@"employee.name = %@", @"lxz"];
request.predicate = predicate;

// æ‰§è¡ŒæŸ¥æ‰¾æ“ä½œ
NSError *error = nil;
NSArray<Department *> *departments = [context executeFetchRequest:request error:&error];
[departments enumerateObjectsUsingBlock:^(Department * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
    NSLog(@"Department Search Result DepartName: %@, employee name: %@", obj.departName, obj.employee.name);
}];

// é”™è¯¯å¤„ç†
if (error) {
    NSLog(@"Department Search Error : %@", error);
}
```

æŸ¥æ‰¾ `Department` å®ä½“ï¼Œå¹¶æ‰“å°å®ä½“å†…å®¹ã€‚å°±åƒä¸Šé¢è®²çš„åŒå‘å…³ç³»ä¸€æ ·ï¼Œæœ‰å…³è”å…³ç³»çš„å®ä½“ï¼Œè‡ªå·±è¢«æŸ¥æ‰¾å‡ºæ¥åï¼Œä¹Ÿä¼šå°†ä¸ä¹‹å…³è”çš„å…¶ä»–å®ä½“ä¹ŸæŸ¥æ‰¾å‡ºæ¥ï¼Œå¹¶ä¸”æŸ¥æ‰¾å‡ºæ¥çš„å®ä½“éƒ½æ˜¯å…³è”ç€ `NSManagedObjectContext` çš„ã€‚

##1.4 åˆ†é¡µæŸ¥è¯¢

```Objective-C
// åˆ›å»ºè·å–æ•°æ®çš„è¯·æ±‚å¯¹è±¡ï¼Œå¹¶æŒ‡æ˜æ“ä½œEmployeeè¡¨
NSFetchRequest *request = [NSFetchRequest fetchRequestWithEntityName:@"Employee"];

// è®¾ç½®æŸ¥æ‰¾èµ·ç‚¹ï¼Œè¿™é‡Œæ˜¯ä»æœç´¢ç»“æœçš„ç¬¬å…­ä¸ªå¼€å§‹è·å–
request.fetchOffset = 6;

// è®¾ç½®åˆ†é¡µï¼Œæ¯æ¬¡è¯·æ±‚è·å–å…­ä¸ªæ‰˜ç®¡å¯¹è±¡
request.fetchLimit = 6;

// è®¾ç½®æ’åºè§„åˆ™ï¼Œè¿™é‡Œè®¾ç½®èº«é«˜å‡åºæ’åº
NSSortDescriptor *descriptor = [NSSortDescriptor sortDescriptorWithKey:@"height" ascending:YES];
request.sortDescriptors = @[descriptor];

// æ‰§è¡ŒæŸ¥è¯¢æ“ä½œ
NSError *error = nil;
NSArray<Employee *> *employees = [context executeFetchRequest:request error:&error];
[employees enumerateObjectsUsingBlock:^(Employee * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
    NSLog(@"Page Search Result Name : %@, height : %f", obj.name, obj.height);
}];

// é”™è¯¯å¤„ç†
if (error) {
    NSLog(@"Page Search Data Error: %@", error);
}
```

##1.5 æ¨¡ç³ŠæŸ¥è¯¢

```Objective-C
// åˆ›å»ºè·å–æ•°æ®çš„è¯·æ±‚å¯¹è±¡ï¼Œè®¾ç½®å¯¹Employeeè¡¨è¿›è¡Œæ“ä½œ
NSFetchRequest *request = [NSFetchRequest fetchRequestWithEntityName:@"Employee"];

// åˆ›å»ºæ¨¡ç³ŠæŸ¥è¯¢æ¡ä»¶ã€‚è¿™é‡Œè®¾ç½®çš„å¸¦é€šé…ç¬¦çš„æŸ¥è¯¢ï¼ŒæŸ¥è¯¢æ¡ä»¶çš„ç»“æœåŒ…å«lxz
NSPredicate *predicate = [NSPredicate predicateWithFormat:@"name LIKE %@", @"*lxz*"];
request.predicate = predicate;

// æ‰§è¡ŒæŸ¥è¯¢æ“ä½œ
NSError *error = nil;
NSArray<Employee *> *employees = [context executeFetchRequest:request error:&error];
[employees enumerateObjectsUsingBlock:^(Employee * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
    NSLog(@"Fuzzy Search Result Name : %@, height : %f", obj.name, obj.height);
}];

// å¤„ç†é”™è¯¯
if (error) {
    NSLog(@"Fuzzy Search Data Error : %@", error);
}
```

ä¸Šé¢æ˜¯ä½¿ç”¨**é€šé…ç¬¦**çš„æ–¹å¼è¿›è¡Œ**æ¨¡ç³ŠæŸ¥è¯¢**ï¼Œ`NSPredicate` æ”¯æŒå¤šç§å½¢å¼çš„æ¨¡ç³ŠæŸ¥è¯¢ï¼Œä¸‹é¢åˆ—ä¸¾ä¸€äº›ç®€å•çš„åŒ¹é…æ–¹å¼ã€‚æ¨¡ç³ŠæŸ¥è¯¢æ¡ä»¶**å¯¹å¤§å°å†™ä¸æ•æ„Ÿ**ï¼Œæ‰€ä»¥æŸ¥è¯¢æ¡ä»¶å¤§å°å†™å‡å¯ã€‚

##1.6 åŠ è½½è¯·æ±‚æ¨¡æ¿

åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­è°ˆåˆ°**åœ¨æ¨¡å‹æ–‡ä»¶ä¸­è®¾ç½®è¯·æ±‚æ¨¡æ¿**ï¼Œä¹Ÿå°±æ˜¯åœ¨ `.xcdatamodeld` æ–‡ä»¶ä¸­ï¼Œè®¾ç½® `FetchRequexts`ï¼Œä½¿ç”¨æ—¶å¯ä»¥é€šè¿‡å¯¹åº”çš„ `NSManagedObjectModel` è·å–è®¾ç½®å¥½çš„æ¨¡æ¿ã€‚

```Objective-C
// é€šè¿‡NSManagedObjectContextè·å–æ¨¡å‹æ–‡ä»¶å¯¹åº”çš„æ‰˜ç®¡å¯¹è±¡æ¨¡å‹
NSManagedObjectModel *model = context.persistentStoreCoordinator.managedObjectModel;
// é€šè¿‡.xcdatamodeldæ–‡ä»¶ä¸­è®¾ç½®çš„æ¨¡æ¿åï¼Œè·å–è¯·æ±‚å¯¹è±¡
NSFetchRequest *fetchRequest = [model fetchRequestTemplateForName:@"EmployeeFR"];

// è¯·æ±‚æ•°æ®ï¼Œ ä¸‹é¢çš„æ“ä½œå’Œæ™®é€šè¯·æ±‚ä¸€æ ·
NSError *error = nil;
NSArray <Employee *> *dataList = [context executeFetchRequest:fetchRequest error:&error];
[dataList enumerateObjectsUsingBlock:^(Employee * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
    NSLog(@"Employee.count = %ld, Employee.height = %f", dataList.count, obj.height);
}];

// é”™è¯¯å¤„ç†
if (error) {
    NSLog(@"Execute Fetch Request Error : %@", error);
}
```

