[toc]

### 1. MTK

#### 1.1 MT8766

##### 1.1.1 Android T

1. 修改 `sys/packages/apps/Launcher3/AndroidManifest-common.xml` 文件的如下代码：

   ```diff
   @@ -43,7 +43,11 @@
        <!-- for rotating surface by arbitrary degree -->
        <uses-permission android:name="android.permission.ROTATE_SURFACE_FLINGER" />
        <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
   -    
   +
   +    <!-- Start Launcher3 Style Switch add by qty -->
   +    <uses-permission android:name="android.permission.WRITE_SETTINGS" />
   +    <uses-permission android:name="android.permission.WRITE_SECURE_SETTINGS"/>
   +    <!-- End Launcher3 Style Switch add by qty -->
        <!--
        Permissions required for read/write access to the workspace data. These permission name
        should not conflict with that defined in other apps, as such an app should embed its package
   ```

2. 修改 `sys/packages/apps/Launcher3/res/values/dimens.xml` 文件的如下代码：

   ```diff
   @@ -409,4 +409,7 @@
        <dimen name="bottom_sheet_handle_height">4dp</dimen>
        <dimen name="bottom_sheet_handle_margin">16dp</dimen>
        <dimen name="bottom_sheet_handle_corner_radius">2dp</dimen>
   +    <!-- Start Launcher3 Style Switch add by qty -->
   +    <dimen name="secondary_app_icon_size">32dp</dimen>
   +    <!-- End Launcher3 Style Switch add by qty -->
    </resources>
   ```

3. 修改 `sys/packages/apps/Launcher3/res/values/styles.xml` 文件的如下代码：

   ```diff
   @@ -324,4 +324,9 @@
            <item name="android:windowLightStatusBar">true</item>
            <item name="android:windowTranslucentStatus">true</item>
        </style>
   +
   +    <!-- Start Launcher3 Style Switch add by qty -->
   +    <style name="TextAppearance.TileTitle" parent="@*android:style/TextAppearance.DeviceDefault.Subhead"/>
   +    <style name="TextAppearance.Small" parent="@android:style/TextAppearance.DeviceDefault.Small"/>
   +    <!-- End Launcher3 Style Switch add by qty -->
    </resources>
   ```

4. 修改 `sys/packages/apps/Launcher3/res/xml/launcher_preferences.xml` 文件的如下代码：

   ```diff
   @@ -56,4 +56,12 @@
            android:title="@string/developer_options_title"
            android:fragment="com.android.launcher3.settings.DeveloperOptionsFragment"/>
    
   +    <!-- Start Launcher3 Style Switch add by qty -->
   +    <androidx.preference.PreferenceScreen
   +        android:key="pref_launcher_style"
   +        android:title="@string/launcher_style_title"
   +        android:summary="@string/launcher_style_summary"
   +        android:fragment="com.android.launcher3.settings.LauncherStyleFragment"
   +        android:persistent="true" />
   +    <!-- Start Launcher3 Style Switch add by qty -->
    </androidx.preference.PreferenceScreen>
   ```

5. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/BaseActivity.java` 文件的如下代码：

   ```diff
   @@ -41,6 +41,10 @@ import java.lang.annotation.Retention;
    import java.util.ArrayList;
    import java.util.List;
    
   +// Add Launcher3 Style Switch add by qty {{&&
   +import com.android.launcher3.beautifyui.LauncherAppMonitor;
   +// &&}}
   +
    /**
     * Launcher BaseActivity
     */
   @@ -79,7 +83,9 @@ public abstract class BaseActivity extends Activity implements AppLauncher,
        protected DeviceProfile mDeviceProfile;
        protected StatsLogManager mStatsLogManager;
        protected SystemUiController mSystemUiController;
   -
   +       // Add Launcher3 Style Switch add by qty {{&&
   +       protected LauncherAppMonitor mAppMonitor;
   +       // &&}}
    
        public static final int ACTIVITY_STATE_STARTED = 1 << 0;
        public static final int ACTIVITY_STATE_RESUMED = 1 << 1;
   @@ -162,6 +168,15 @@ public abstract class BaseActivity extends Activity implements AppLauncher,
            return mSystemUiController;
        }
    
   +    // Add Launcher3 Style Switch add by qty {{&&
   +    public LauncherAppMonitor getAppMonitor() {
   +               if (mAppMonitor == null) {
   +                       mAppMonitor = LauncherAppMonitor.getInstance(this);
   +               }
   +               return mAppMonitor;
   +    }
   +    // &&}}
   +
        public ScrimView getScrimView() {
            return null;
        }
   @@ -224,6 +239,9 @@ public abstract class BaseActivity extends Activity implements AppLauncher,
        @Override
        public void onWindowFocusChanged(boolean hasFocus) {
            super.onWindowFocusChanged(hasFocus);
   +               // Add Launcher3 Style Switch add by qty {{&&
   +               getAppMonitor().onLauncherFocusChanged(hasFocus);
   +               // &&}}
            if (hasFocus) {
                addActivityFlags(ACTIVITY_STATE_WINDOW_FOCUSED);
            } else {
   ```

6. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/CellLayout.java` 文件的如下代码：

   ```diff
   @@ -872,8 +872,9 @@ public class CellLayout extends ViewGroup {
         * @param cellY Y coordinate of the cell
         *
         * @param result Array of 2 ints to hold the x and y coordinate of the point
         */
   -    void cellToCenterPoint(int cellX, int cellY, int[] result) {
   +    // Add Launcher3 Style Switch add by qty {{&&
   +	/*
   +	void cellToCenterPoint(int cellX, int cellY, int[] result) {
   +	*/
   +    public void cellToCenterPoint(int cellX, int cellY, int[] result) {
   +	// &&}}
            regionToCenterPoint(cellX, cellY, 1, 1, result);
        }
    
   @@ -2941,7 +2942,9 @@ public class CellLayout extends ViewGroup {
        public static final class CellInfo extends CellAndSpan {
            public final View cell;
            final int screenId;
   -        final int container;
   +        // Add Launcher3 Style Switch add by qty {{&&t
   +		 // final int container;
   +        public final int container;
   +        // &&}}
    
            public CellInfo(View v, ItemInfo info) {
                cellX = info.cellX;
   ```

7. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/DeleteDropTarget.java` 文件如下代码：

   ```diff
   @@ -100,6 +100,13 @@ public class DeleteDropTarget extends ButtonDropTarget {
                mText = getResources().getString(canRemove(item)
                        ? R.string.remove_drop_target_label
                        : android.R.string.cancel);
   +            // Add Launcher3 Style Switch add by qty {{&&
   +            if (android.provider.Settings.System.getInt(getContext().getContentResolver(), "launcher_style", 0) == 1) {
   +                               mText = getResources().getString(isCanDrop(item)
   +                    ? R.string.remove_drop_target_label
   +                    : android.R.string.cancel);
   +                       } 
   +            // &&}}
                setContentDescription(mText);
                requestLayout();
            }
   @@ -115,6 +122,12 @@ public class DeleteDropTarget extends ButtonDropTarget {
        private void setControlTypeBasedOnDragSource(ItemInfo item) {
            mLauncherEvent = item.id != ItemInfo.NO_ID ? LAUNCHER_ITEM_DROPPED_ON_REMOVE
                    : LAUNCHER_ITEM_DROPPED_ON_CANCEL;
   +        // Add Launcher3 Style Switch add by qty {{&&
   +        if (android.provider.Settings.System.getInt(getContext().getContentResolver(), "launcher_style", 0) == 1) {
   +            mLauncherEvent = isCanDrop(item) ? LAUNCHER_ITEM_DROPPED_ON_REMOVE
   +                    : LAUNCHER_ITEM_DROPPED_ON_CANCEL;
   +        }
   +        // &&}}
        }
    
        @Override
   @@ -150,8 +163,24 @@ public class DeleteDropTarget extends ButtonDropTarget {
                    modelWriter.abortDelete();
                    mLauncher.getStatsLogManager().logger().log(LAUNCHER_UNDO);
                };
   -            Snackbar.show(mLauncher, R.string.item_removed, R.string.undo,
   -                    modelWriter::commitDelete, onUndoClicked);
   +            // Add Launcher3 Style Switch add by qty {{&&
   +            try{
   +                boolean isWidget = item instanceof LauncherAppWidgetInfo;
   +                String itPackage = item.getTargetComponent().getPackageName();
   +                boolean isSettingPac= itPackage.equals("com.android.settings");
   +                boolean isSettingWid = item.itemType!=0;
   +                if(android.provider.Settings.System.getInt(getContext().getContentResolver(), "launcher_style", 0) == 0 || isWidget || isSettingWid){
   +                    Snackbar.show(mLauncher, R.string.item_removed, R.string.undo,
   +					               modelWriter::commitDelete, onUndoClicked);                              
   +                }else{
   +                    Snackbar.show(mLauncher, R.string.item_unremoved, R.string.undo,
   +                                  modelWriter::commitDelete, onUndoClicked);                      
   +                }
   +            }catch(Exception e){
   +                Snackbar.show(mLauncher, R.string.item_removed, R.string.undo,
   +                              modelWriter::commitDelete, onUndoClicked);                      
   +            }
   +            // &&}}
            }
        }
    
   @@ -163,9 +192,24 @@ public class DeleteDropTarget extends ButtonDropTarget {
            // Remove the item from launcher and the db, we can ignore the containerInfo in this call
            // because we already remove the drag view from the folder (if the drag originated from
            // a folder) in Folder.beginDrag()
   -        mLauncher.removeItem(view, item, true /* deleteFromDb */, "removed by accessibility drop");
   -        mLauncher.getWorkspace().stripEmptyScreens();
   -        mLauncher.getDragLayer()
   -                .announceForAccessibility(getContext().getString(R.string.item_removed));
   +
   +        // Add Launcher3 Style Switch add by qty {{&&
   +        //mLauncher.removeItem(view, item, true /* deleteFromDb */);
   +        //mLauncher.getWorkspace().stripEmptyScreens();
   +        //mLauncher.getDragLayer()
   +        //              .announceForAccessibility(getContext().getString(R.string.item_removed));
   +        if(android.provider.Settings.System.getInt(getContext().getContentResolver(), "launcher_style", 0) == 0 || isCanDrop(item)) {
   +            mLauncher.removeItem(view, item, true /* deleteFromDb */);
   +            mLauncher.getWorkspace().stripEmptyScreens();
   +            mLauncher.getDragLayer()
   +                     .announceForAccessibility(getContext().getString(R.string.item_removed));
   +        }
   +        // &&}}
   +    }
   +
   +    // Add Launcher3 Style Switch add by qty {{&&
   +    private boolean isCanDrop(ItemInfo item){
   +        return !(item.itemType == LauncherSettings.Favorites.ITEM_TYPE_APPLICATION ||
   +                item.itemType == LauncherSettings.Favorites.ITEM_TYPE_FOLDER);
        }
   +    // &&}}
    }
   ```

8. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/Hotseat.java` 文件的如下代码：

   ```diff
   @@ -31,6 +31,11 @@ import androidx.annotation.Nullable;
    
    import java.util.function.Consumer;
    
   +// Add Launcher3 Style Switch add by qty {{&&
   +import com.android.launcher3.beautifyui.LauncherAppMonitor;
   +import com.android.launcher3.beautifyui.HotseatController;
   +// &&}}
   +
    /**
     * View class that represents the bottom row of the home screen.
     */
   @@ -40,7 +45,10 @@ public class Hotseat extends CellLayout implements Insettable {
        public static final float QSB_CENTER_FACTOR = .325f;
    
        @ViewDebug.ExportedProperty(category = "launcher")
   -    private boolean mHasVerticalHotseat;
   +    // Add Launcher3 Style Switch add by qty {{&&
   +    public boolean mHasVerticalHotseat;
   +    private final HotseatController mController;
   +    // &&}}
        private Workspace<?> mWorkspace;
        private boolean mSendTouchToWorkspace;
        @Nullable
   @@ -59,13 +67,21 @@ public class Hotseat extends CellLayout implements Insettable {
    
        public Hotseat(Context context, AttributeSet attrs, int defStyle) {
            super(context, attrs, defStyle);
   -
   +        // Add Launcher3 Style Switch add by qty {{&&
   +        mController = LauncherAppMonitor.getInstance(context).getHotseatController();
   +        // &&}}
            mQsb = LayoutInflater.from(context).inflate(R.layout.search_container_hotseat, this, false);
            addView(mQsb);
    
            mQsbHeight = getResources().getDimensionPixelSize(R.dimen.qsb_widget_height);
        }
    
   +    // Add Launcher3 Style Switch add by qty {{&&
   +    public HotseatController getController() {
   +               return mController;
   +    }
   +    // &&}}
   +       
        /**
         * Returns orientation specific cell X given invariant order in the hotseat
         */
   ```

9. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/Launcher.java` 文件的如下代码：

   ```diff
   @@ -232,6 +232,11 @@ import java.util.function.Predicate;
    import java.util.function.Supplier;
    import java.util.stream.Stream;
    
   +// Add Launcher3 Style Switch add by qty {{&&
   +import com.android.launcher3.beautifyui.LauncherAppMonitor;
   +import com.android.launcher3.beautifyui.HotseatController;
   +// &&}}
   +
    /**
     * Default launcher application.
     */
   @@ -386,6 +391,10 @@ public class Launcher extends StatefulActivity<LauncherState>
        private LauncherState mPrevLauncherState;
    
        private StringCache mStringCache;
   +       
   +       // Add Launcher3 Style Switch add by qty {{&&
   +       private LauncherAppMonitor mAppMonitor;
   +       // &&}}
    
        @Override
        @TargetApi(Build.VERSION_CODES.S)
   @@ -397,6 +406,9 @@ public class Launcher extends StatefulActivity<LauncherState>
                Trace.beginAsyncSection(DISPLAY_ALL_APPS_TRACE_METHOD_NAME,
                        DISPLAY_ALL_APPS_TRACE_COOKIE);
            }
   +               // Add Launcher3 Style Switch add by qty {{&&
   +               getAppMonitor();
   +               // &&}}
            Object traceToken = TraceHelper.INSTANCE.beginSection(ON_CREATE_EVT,
                    TraceHelper.FLAG_UI_EVENT);
            if (DEBUG_STRICT_MODE) {
   @@ -539,6 +551,10 @@ public class Launcher extends StatefulActivity<LauncherState>
            mRotationHelper.initialize();
            TraceHelper.INSTANCE.endSection(traceToken);
    
   +               // Add Launcher3 Style Switch add by qty {{&&
   +               mAppMonitor.onLauncherCreated();
   +               // &&}}
   +
            mUserChangedCallbackCloseable = UserCache.INSTANCE.get(this).addUserChangeListener(
                    () -> getStateManager().goToState(NORMAL));
    
   @@ -882,6 +898,14 @@ public class Launcher extends StatefulActivity<LauncherState>
                }
            }
    
   +        // Add Launcher3 Style Switch add by qty {{&&
   +        HotseatController hc = mHotseat.getController();
   +        if (hc != null) {
   +            hc.setDelayClearEmptyGridFlag(false);
   +            hc.clearEmptyGrid(this);
   +        }
   +        // &&}}
   +
            mDragLayer.clearAnimatedView();
        }
    
   @@ -896,6 +920,9 @@ public class Launcher extends StatefulActivity<LauncherState>
        public void onRequestPermissionsResult(int requestCode, String[] permissions,
                int[] grantResults) {
            PendingRequestArgs pendingArgs = mPendingRequestArgs;
   +               // Add Launcher3 Style Switch add by qty {{&&
   +               mAppMonitor.onLauncherRequestPermissionsResult(requestCode, permissions, grantResults);
   +               // &&}}
            if (requestCode == REQUEST_PERMISSION_CALL_PHONE && pendingArgs != null
                    && pendingArgs.getRequestCode() == REQUEST_PERMISSION_CALL_PHONE) {
                setWaitingForResult(null);
   @@ -982,6 +1009,9 @@ public class Launcher extends StatefulActivity<LauncherState>
            logStopAndResume(false /* isResume */);
            mAppWidgetHost.setActivityStarted(false);
            NotificationListener.removeNotificationsChangedListener(getPopupDataProvider());
   +               // Add Launcher3 Style Switch add by qty {{&&
   +               mAppMonitor.onLauncherStop();
   +               // &&}}
        }
    
        @Override
   @@ -995,6 +1025,9 @@ public class Launcher extends StatefulActivity<LauncherState>
    
            mAppWidgetHost.setActivityStarted(true);
            TraceHelper.INSTANCE.endSection(traceToken);
   +        // Add Launcher3 Style Switch add by qty {{&&
   +        mAppMonitor.onLauncherStart();
   +        // &&}}
        }
    
        @Override
   @@ -1012,8 +1045,13 @@ public class Launcher extends StatefulActivity<LauncherState>
            // Set the notification listener and fetch updated notifications when we resume
            NotificationListener.addNotificationsChangedListener(mPopupDataProvider);
    
   -        DiscoveryBounce.showForHomeIfNeeded(this);
   -        mAppWidgetHost.setActivityResumed(true);
   +        // Add Launcher3 Style Switch add by qty {{&&
   +               //DiscoveryBounce.showForHomeIfNeeded(this);
   +               if(android.provider.Settings.System.getInt(getContentResolver(), "launcher_style", 0) == 0) {
   +               DiscoveryBounce.showForHomeIfNeeded(this);
   +               }
   +               mAppWidgetHost.setActivityResumed(true);
   +               // &&}}
        }
    
        private void logStopAndResume(boolean isResume) {
   @@ -1170,6 +1208,9 @@ public class Launcher extends StatefulActivity<LauncherState>
        protected void onResume() {
            Object traceToken = TraceHelper.INSTANCE.beginSection(ON_RESUME_EVT,
                    TraceHelper.FLAG_UI_EVENT);
   +               // Add Launcher3 Style Switch add by qty {{&&
   +               mAppMonitor.onLauncherPreResume();
   +               // &&}}
            super.onResume();
    
            if (mDeferOverlayCallbacks) {
   @@ -1180,6 +1221,9 @@ public class Launcher extends StatefulActivity<LauncherState>
    
            AbstractFloatingView.closeAllOpenViewsExcept(this, false, TYPE_REBIND_SAFE);
            DragView.removeAllViews(this);
   +               // Add Launcher3 Style Switch add by qty {{&&
   +               mAppMonitor.onLauncherResumed();
   +               // &&}}
            TraceHelper.INSTANCE.endSection(traceToken);
        }
    
   @@ -1187,7 +1231,9 @@ public class Launcher extends StatefulActivity<LauncherState>
        protected void onPause() {
            // Ensure that items added to Launcher are queued until Launcher returns
            ItemInstallQueue.INSTANCE.get(this).pauseModelPush(FLAG_ACTIVITY_PAUSED);
   -
   +               // Add Launcher3 Style Switch add by qty {{&&
   +               mAppMonitor.onLauncherPrePause();
   +               // &&}}
            super.onPause();
            mDragController.cancelDrag();
            mLastTouchUpTime = -1;
   @@ -1197,6 +1243,9 @@ public class Launcher extends StatefulActivity<LauncherState>
                mOverlayManager.onActivityPaused(this);
            }
            mAppWidgetHost.setActivityResumed(false);
   +               // Add Launcher3 Style Switch add by qty {{&&
   +               mAppMonitor.onLauncherPaused();
   +               // &&}}
        }
    
        /**
   @@ -1592,6 +1641,9 @@ public class Launcher extends StatefulActivity<LauncherState>
            hideKeyboard();
    
            if (isActionMain) {
   +                       // Add Launcher3 Style Switch add by qty {{&&
   +                       mAppMonitor.onReceiveHomeIntent();
   +                       // &&}}
                if (!internalStateHandled) {
                    // In all these cases, only animate if we're already on home
                    closeOpenViews(isStarted());
   @@ -2487,6 +2539,14 @@ public class Launcher extends StatefulActivity<LauncherState>
            } else if (focusFirstItemForAccessibility && viewToFocus != null) {
                viewToFocus.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_FOCUSED);
            }
   +        // Add Launcher3 Style Switch add by qty {{&&
   +        if (mHotseat != null) {
   +                       HotseatController hc = mHotseat.getController();
   +                       if (hc != null) {
   +                               hc.clearEmptyGrid(this);
   +                       }
   +        }
   +        // &&}}
            workspace.requestLayout();
        }
    
   @@ -2744,6 +2804,10 @@ public class Launcher extends StatefulActivity<LauncherState>
                    mDeviceProfile.inv.numFolderColumns * mDeviceProfile.inv.numFolderRows);
            getViewCache().setCacheSize(R.layout.folder_page, 2);
    
   +               // Add Launcher3 Style Switch add by qty {{&&
   +               mAppMonitor.onLauncherWorkspaceBindingFinish();
   +               // &&}}
   +
            TraceHelper.INSTANCE.endSection(traceToken);
        }
    
   @@ -2873,6 +2937,9 @@ public class Launcher extends StatefulActivity<LauncherState>
        @TargetApi(Build.VERSION_CODES.S)
        public void bindAllApplications(AppInfo[] apps, int flags) {
            mAppsView.getAppsStore().setApps(apps, flags);
   +        // Add Launcher3 Style Switch add by qty {{&&
   +        mAppMonitor.onLauncherAllAppBindingFinish(apps);
   +        // &&}}
            PopupContainerWithArrow.dismissInvalidPopup(this);
            if (Utilities.ATLEAST_S) {
                Trace.endAsyncSection(DISPLAY_ALL_APPS_TRACE_METHOD_NAME,
   @@ -3273,4 +3340,13 @@ public class Launcher extends StatefulActivity<LauncherState>
                return false; // Return false to continue iterating through all the items.
            });
        }
   +       
   +    // Add Launcher3 Style Switch add by qty {{&&
   +    public LauncherAppMonitor getAppMonitor() {
   +               if (mAppMonitor == null) {
   +                       mAppMonitor = LauncherAppMonitor.getInstance(this);
   +               }
   +               return mAppMonitor;
   +    }
   +    // &&}}
    }
   ```

10. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/LauncherAppState.java` 文件的如下代码：

    ```diff
    @@ -52,6 +52,12 @@ import com.android.launcher3.util.SettingsCache;
     import com.android.launcher3.util.SimpleBroadcastReceiver;
     import com.android.launcher3.util.Themes;
     import com.android.launcher3.widget.custom.CustomWidgetManager;
    +// Add Launcher3 Style Switch add by qty {{&&
    +import android.database.ContentObserver;
    +import android.net.Uri;
    +import android.provider.Settings;
    +import android.os.Handler;
    +// &&}}
     
     public class LauncherAppState implements SafeCloseable {
     
    @@ -68,6 +74,17 @@ public class LauncherAppState implements SafeCloseable {
         private final IconCache mIconCache;
         private final InvariantDeviceProfile mInvariantDeviceProfile;
         private final RunnableList mOnTerminateCallback = new RunnableList();
    +    // Add Launcher3 Style Switch add by qty {{&&
    +    private ContentObserver mLauncherStyleChangedObserver = new ContentObserver(new Handler()) {
    +        @Override
    +        public void onChange(boolean selfChange, Uri uri) {
    +            super.onChange(selfChange, uri);  
    +            if (Settings.System.getUriFor("launcher_style").equals(uri)) {
    +                               mModel.forceReload();
    +                       }
    +               }
    +    };
    +    // &&}}
     
         public static LauncherAppState getInstance(final Context context) {
             return INSTANCE.get(context);
    @@ -136,6 +153,11 @@ public class LauncherAppState implements SafeCloseable {
             onNotificationSettingsChanged(settingsCache.getValue(NOTIFICATION_BADGING_URI));
             mOnTerminateCallback.add(() ->
                     settingsCache.unregister(NOTIFICATION_BADGING_URI, notificationLister));
    +               // Add Launcher3 Style Switch add by qty {{&&20230616 start
    +        mContext.getContentResolver().registerContentObserver(Settings.System.getUriFor("launcher_style"),
    +                               false, mLauncherStyleChangedObserver);
    +        // &&}}
    +
         }
     
         public LauncherAppState(Context context, @Nullable String iconCacheFileName) {
    @@ -173,6 +195,9 @@ public class LauncherAppState implements SafeCloseable {
             mContext.getSystemService(LauncherApps.class).unregisterCallback(mModel);
             CustomWidgetManager.INSTANCE.get(mContext).setWidgetRefreshCallback(null);
             mOnTerminateCallback.executeAllAndDestroy();
    +        // Add Launcher3 Style Switch add by qty {{&&
    +        mContext.getContentResolver().unregisterContentObserver(mLauncherStyleChangedObserver);
    +        // &&}}
         }
     
         public IconProvider getIconProvider() {
    ```

11. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/allapps/AllAppsTransitionController.java` 文件的如下代码：

    ```diff
    @@ -230,6 +230,11 @@ public class AllAppsTransitionController
         @Override
         public void setStateWithAnimation(LauncherState toState,
                 StateAnimationConfig config, PendingAnimation builder) {
    +        // Add Launcher3 Style Switch add by qty {{&&
    +        if (android.provider.Settings.System.getInt(mLauncher.getContentResolver(), "launcher_style", 0) == 1) {
    +            return;
    +        }
    +        // &&}}                  
             if (NORMAL.equals(toState) && mLauncher.isInState(ALL_APPS)) {
                 UiThreadHelper.hideKeyboardAsync(mLauncher, mLauncher.getAppsView().getWindowToken());
                 builder.addEndListener(success -> {
    ```

12. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/dragndrop/DragController.java` 文件的如下代码：

    ```diff
    @@ -41,7 +41,11 @@ import com.android.launcher3.views.ActivityContext;
     import java.util.ArrayList;
     import java.util.Optional;
     import java.util.function.Predicate;
    -
    +// Add Launcher3 Style Switch add by qty {{&&
    +import com.android.launcher3.DeleteDropTarget;
    +import com.android.launcher3.LauncherSettings;
    +import android.app.Activity;
    +// &&}}
     /**
      * Class for initiating a drag within a view or across multiple views.
      * @param <T>
    @@ -89,7 +93,9 @@ public abstract class DragController<T extends ActivityContext>
         protected int mDistanceSinceScroll = 0;
     
         protected boolean mIsInPreDrag;
    -
    +    // Add Launcher3 Style Switch add by qty {{&&
    +    public static boolean isHomeScreen;
    +    // &&}}
         /**
          * Interface to receive notifications when a drag starts or stops
          */
    @@ -537,11 +543,26 @@ public abstract class DragController<T extends ActivityContext>
                         dropTarget.onDrop(mDragObject, mOptions);
                     }
                     accepted = true;
    +                // Add Launcher3 Style Switch add by qty {{&&
    +                isHomeScreen = android.provider.Settings.System.getInt(((Activity) mActivity).getContentResolver(), "launcher_style", 0) == 1;
    +                if (isHomeScreen
    +                                               && dropTarget instanceof DeleteDropTarget &&
    +                        isNeedCancelDrag(mDragObject.dragInfo)) {
    +                    cancelDrag();
    +                }
    +                // &&}}
                 }
             }
             final View dropTargetAsView = dropTarget instanceof View ? (View) dropTarget : null;
             dispatchDropComplete(dropTargetAsView, accepted);
         }
    +    
    +    // Add Launcher3 Style Switch add by qty {{&&
    +    private boolean isNeedCancelDrag(ItemInfo item){
    +        return (item.itemType == LauncherSettings.Favorites.ITEM_TYPE_APPLICATION ||
    +                item.itemType == LauncherSettings.Favorites.ITEM_TYPE_FOLDER);
    +    }
    +    // &&}}
     
         private DropTarget findDropTarget(int x, int y, int[] dropCoordinates) {
             mDragObject.x = x;
    ```

13. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/model/AddWorkspaceItemsTask.java` 文件的如下代码：

    ```diff
    @@ -98,11 +98,12 @@ public class AddWorkspaceItemsTask extends BaseModelUpdateTask {
                         }
     
                         // b/139663018 Short-circuit this logic if the icon is a system app
    -                    if (PackageManagerHelper.isSystemApp(app.getContext(), item.getIntent())) {
    -                        if (TestProtocol.sDebugTracing) {
    -                            Log.d(TestProtocol.MISSING_PROMISE_ICON,
    -                                    LOG + " Item is a system app.");
    -                        }
    +                    // Add Launcher3 Style Switch add by qty {{&&
    +                    //if (PackageManagerHelper.isSystemApp(app.getContext(), item.getIntent())) {
    +                    if (PackageManagerHelper.isSystemApp(app.getContext(), item.getIntent())
    +                                                       && (android.provider.Settings.System.getInt(app.getContext().getContentResolver(), "launcher_style", 0) != 1)) {
    +                    // &&}}
    +
                             continue;
                         }
                     }
    ```

14. 修改 `packages/apps/Launcher3/src/com/android/launcher3/model/BaseModelUpdateTask.java` 文件中的如下代码：

    ```diff
    @@ -69,7 +69,11 @@ public abstract class BaseModelUpdateTask implements ModelUpdateTask {
                     Log.d(TAG, "Ignoring model task since loader is pending=" + this);
                 }
                 // Loader has not yet run.
    -            return;
    +            // Add Launcher3 Style Switch add by qty {{&&
    +            if (android.provider.Settings.System.getInt(mApp.getContext().getContentResolver(), "launcher_style", 0) == 0) {
    +                return;
    +            }
    +            // &&}}
             }
             execute(mApp, mDataModel, mAllAppsList);
         }
    ```

15. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/model/ItemInstallQueue.java` 文件中的如下代码：

    ```diff
    @@ -246,9 +246,9 @@ public class ItemInstallQueue {
             }
             MODEL_EXECUTOR.post(this::flushQueueInBackground);
         }
    -
    -    private static class PendingInstallShortcutInfo extends ItemInfo {
    -
    +    // Add Launcher3 Style Switch add by qty {{&&
    +    public static class PendingInstallShortcutInfo extends ItemInfo {
    +    // &&}}
             final Intent intent;
     
             @Nullable ShortcutInfo shortcutInfo;
    ```

16. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/model/LoaderTask.java` 文件的如下代码：

    ```diff
    @@ -105,6 +105,9 @@ import java.util.List;
     import java.util.Map;
     import java.util.Set;
     import java.util.concurrent.CancellationException;
    +// Add Launcher3 Style Switch add by qty {{&&
    +import android.util.Pair;
    +// &&}}
     
     /**
      * Runnable for the thread that loads the contents of the launcher:
    @@ -242,6 +245,11 @@ public class LoaderTask implements Runnable {
                 } finally {
                     Trace.endSection();
                 }
    +            // Add Launcher3 Style Switch add by qty {{&&
    +            if (android.provider.Settings.System.getInt(mApp.getContext().getContentResolver(), "launcher_style", 0) == 1) {
    +               verifyApplications();
    +            }
    +            // &&}}                       
                 logASplit(logger, "loadAllApps");
     
                 verifyNotStopped();
    @@ -359,7 +367,14 @@ public class LoaderTask implements Runnable {
                 // Migration failed. Clear workspace.
                 clearDb = true;
             }
    -
    +               
    +        // Add Launcher3 Style Switch add by qty {{&&
    +        if (android.provider.Settings.System.getInt(contentResolver, "launcher_style_change", 0) == 1) {
    +                       clearDb = true;
    +                       android.provider.Settings.System.putInt(contentResolver, "launcher_style_change", 0);
    +        }
    +        // &&}}
    +               
             if (clearDb) {
                 Log.d(TAG, "loadWorkspace: resetting launcher database");
                 LauncherSettings.Settings.call(contentResolver,
    @@ -1067,6 +1082,41 @@ public class LoaderTask implements Runnable {
                     && (provider.provider.getPackageName() != null);
         }
     
    +
    +    // Add Launcher3 Style Switch add by qty {{&&
    +    private void verifyApplications() {
    +        final Context context = mApp.getContext();
    +        ArrayList<Pair<ItemInfo, Object>> installQueue = new ArrayList<>();
    +        final List<UserHandle> profiles = mUserManager.getUserProfiles();
    +        for (UserHandle user : profiles) {
    +            final List<LauncherActivityInfo> apps = mLauncherApps.getActivityList(null, user);
    +            android.util.Log.i("Launcher3", "apps.size "+apps.size());
    +            ArrayList<ItemInstallQueue.PendingInstallShortcutInfo> added = new ArrayList<ItemInstallQueue.PendingInstallShortcutInfo>();
    +            synchronized (this) {
    +                for (LauncherActivityInfo app : apps) {
    +                    ItemInstallQueue.PendingInstallShortcutInfo pendingInstallShortcutInfo
    +                            = new ItemInstallQueue.PendingInstallShortcutInfo(app.getComponentName().getPackageName(), app.getUser());
    +                    String pkgName = pendingInstallShortcutInfo.getItemInfo(context).first.getTargetComponent().getPackageName();
    +                    if(!"com.mediatek.gnss.nonframeworklbs".equals(pkgName)
    +                            && !"com.debug.loggerui".equals(pkgName)
    +                            && !"com.google.android.overlay.gms.documentsui".equals(pkgName)
    +                            && !"com.google.android.documentsui".equals(pkgName)
    +                            && !"com.androidfung.drminfo".equals(pkgName)){
    +                        added.add(pendingInstallShortcutInfo);
    +                        installQueue.add(pendingInstallShortcutInfo.getItemInfo(context));
    +                        android.util.Log.d("Launcher3", "app pkg "+app.getComponentName().getPackageName());                                   
    +                    }
    +                }
    +            }
    +            if (!added.isEmpty()) {
    +                android.util.Log.i("Launcher3", "installQueue.size "+installQueue.size());
    +                mApp.getModel().addAndBindAddedWorkspaceItems(installQueue);
    +            }
    +        }
    +    }
    +    // &&}}
    +
    +
         @SuppressLint("NewApi") // Already added API check.
         private static void logWidgetInfo(InvariantDeviceProfile idp,
                 LauncherAppWidgetProviderInfo widgetProviderInfo) {
    ```

17. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/model/PackageUpdatedTask.java` 文件的如下代码：

    ```diff
    @@ -58,6 +58,11 @@ import java.util.HashMap;
     import java.util.HashSet;
     import java.util.List;
     import java.util.function.Predicate;
    +// Add Launcher3 Style Switch add by qty {{&&
    +import android.content.pm.LauncherActivityInfo;
    +import android.util.Pair;
    +import com.android.launcher3.model.data.AppInfo;
    +// &&}}
     
     /**
      * Handles updates due to changes in package manager (app installed/updated/removed)
    @@ -174,6 +179,11 @@ public class PackageUpdatedTask extends BaseModelUpdateTask {
                     flagOp = FlagOp.NO_OP;
                     break;
             }
    +        // Add Launcher3 Style Switch add by qty {{&&
    +        if(android.provider.Settings.System.getInt(context.getContentResolver(), "launcher_style", 0) == 1){
    +            updateToWorkSpace(context, app, appsList);
    +        }
    +        // &&}}
     
             bindApplicationsIfNeeded();
     
    @@ -360,6 +370,39 @@ public class PackageUpdatedTask extends BaseModelUpdateTask {
             }
         }
     
    +
    +    // Add Launcher3 Style Switch add by qty {{&&
    +    public void updateToWorkSpace(Context context, LauncherAppState app , AllAppsList appsList){
    +         ArrayList<Pair<ItemInfo, Object>> installQueue = new ArrayList<>();
    +        // final List<UserHandle> profiles = UserManagerCompat.getInstance(context).getUserProfiles();
    +        UserManager mUserManager = context.getSystemService(UserManager.class);
    +        LauncherApps launcherApps = context.getSystemService(LauncherApps.class);
    +        final List<UserHandle> profiles = mUserManager.getUserProfiles();
    +        ArrayList<ItemInstallQueue.PendingInstallShortcutInfo> added 
    +        = new ArrayList<ItemInstallQueue.PendingInstallShortcutInfo>();
    +        
    +        for (UserHandle user : profiles) {
    +            // final List<LauncherActivityInfo> apps = LauncherAppsCompat.getInstance(context).getActivityList(null, user);
    +            final List<LauncherActivityInfo> apps = launcherApps.getActivityList(null, user);
    +            synchronized (this) {
    +                for (LauncherActivityInfo info : apps) {
    +                    for (AppInfo appInfo : appsList.data) {
    +                        if(info.getComponentName().equals(appInfo.componentName)){
    +                            ItemInstallQueue.PendingInstallShortcutInfo mPendingInstallShortcutInfo 
    +                            =  new ItemInstallQueue.PendingInstallShortcutInfo(info.getComponentName().getPackageName(), info.getUser());
    +                            added.add(mPendingInstallShortcutInfo);
    +                            installQueue.add(mPendingInstallShortcutInfo.getItemInfo(context));
    +                        }
    +                    }
    +                }
    +            }
    +        }
    +        if (!added.isEmpty()) {
    +            app.getModel().addAndBindAddedWorkspaceItems(installQueue);
    +        }
    +     }
    +     // &&}}
    +
         /**
          * Updates {@param si}'s intent to point to a new ComponentName.
          * @return Whether the shortcut intent was changed.
    ```

18. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/model/WorkspaceItemSpaceFinder.java` 文件中的如下代码：

    ```diff
    @@ -66,9 +66,9 @@ public class WorkspaceItemSpaceFinder {
             int screenCount = workspaceScreens.size();
             // First check the preferred screen.
             IntSet screensToExclude = new IntSet();
    -        if (FeatureFlags.QSB_ON_FIRST_SCREEN) {
    +        // Add Launcher3 Style Switch add by qty {{&&
    +        //if (FeatureFlags.QSB_ON_FIRST_SCREEN) { 
    +		 // &&}}
                 screensToExclude.add(FIRST_SCREEN_ID);
    -        }
    +		 // Add Launcher3 Style Switch add by qty {{&&
    +        //}
    + 		 // &&}}
     
             for (int screen = 0; screen < screenCount; screen++) {
                 screenId = workspaceScreens.get(screen);
    ```

19. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/settings/SettingsActivity.java` 文件的如下代码：

    ```diff
    @@ -54,6 +54,7 @@ import com.android.launcher3.uioverrides.plugins.PluginManagerWrapper;
     
     import java.util.Collections;
     import java.util.List;
    +// Add Launcher3 Style Switch add by qty {{&&
    +import android.provider.Settings;
    +// &&}}
     
     /**
      * Settings activity for Launcher. Currently implements the following setting: Allow rotation
    @@ -127,10 +128,13 @@ public class SettingsActivity extends FragmentActivity
     
             if (TextUtils.isEmpty(preferenceFragment)) {
                 return defaultFragment;
    +        // Add Launcher3 Style Switch add by qty {{&&
             } else if (!preferenceFragment.equals(defaultFragment)
    -                && !VALID_PREFERENCE_FRAGMENTS.contains(preferenceFragment)) {
    +                && !VALID_PREFERENCE_FRAGMENTS.contains(preferenceFragment)
    +                               && !android.os.SystemProperties.getBoolean("persist.sys.launcher.style",false)) {
                 throw new IllegalArgumentException(
                         "Invalid fragment for this activity: " + preferenceFragment);
    +        // &&}}                           
             } else {
                 return preferenceFragment;
             }
    @@ -189,6 +193,11 @@ public class SettingsActivity extends FragmentActivity
             private boolean mPreferenceHighlighted = false;
             private Preference mDeveloperOptionPref;
     
    +        // Add Launcher3 Style Switch add by qty {{&&
    +        private static final String LAUNCHER_STYLE_PREFERENCE_KEY = "pref_launcher_style";
    +        private PreferenceScreen mLauncherStylePref;
    +        // &&}}
    +
             @Override
             public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
                 final Bundle args = getArguments();
    @@ -204,6 +213,14 @@ public class SettingsActivity extends FragmentActivity
                 getPreferenceManager().setSharedPreferencesName(LauncherFiles.SHARED_PREFERENCES_KEY);
                 setPreferencesFromResource(R.xml.launcher_preferences, rootKey);
     
    +            // Add Launcher3 Style Switch add by qty {{&&
    +                       int style = Settings.System.getInt(getActivity().getContentResolver(), "launcher_style", 0);
    +                       mLauncherStylePref = (PreferenceScreen) findPreference(LAUNCHER_STYLE_PREFERENCE_KEY);
    +                       if (mLauncherStylePref != null) {
    +                               mLauncherStylePref.setSummary(style == 0 ? 
    +                                       getString(R.string.launcher_style_drawer) : getString(R.string.launcher_style_nomal));
    +                       }
    +            // &&}}
                 PreferenceScreen screen = getPreferenceScreen();
                 for (int i = screen.getPreferenceCount() - 1; i >= 0; i--) {
                     Preference preference = screen.getPreference(i);
    @@ -278,6 +295,14 @@ public class SettingsActivity extends FragmentActivity
                     case DEVELOPER_OPTIONS_KEY:
                         mDeveloperOptionPref = preference;
                         return updateDeveloperOption();
    +
    +                // Add Launcher3 Style Switch add by qty {{&&
    +                               case LAUNCHER_STYLE_PREFERENCE_KEY:
    +                                       if (android.os.SystemProperties.getBoolean("persist.sys.launcher.style",false)) {
    +                                               return true;
    +                                       }
    +                                       return false;
    +                // &&}}
                 }
     
                 return true;
    @@ -316,6 +341,13 @@ public class SettingsActivity extends FragmentActivity
                         requestAccessibilityFocus(getListView());
                     }
                 }
    +            // Add Launcher3 Style Switch add by qty {{&&
    +            int style = Settings.System.getInt(getActivity().getContentResolver(), "launcher_style", 0);
    +                       if (mLauncherStylePref != null) {
    +                               mLauncherStylePref.setSummary(style == 0 ? 
    +                                       getString(R.string.launcher_style_drawer) : getString(R.string.launcher_style_nomal));
    +                       }
    +            // &&}}
             }
     
             private PreferenceHighlighter createHighlighter() {
    ```

20. 修改 `sys/packages/apps/Launcher3/src/com/android/launcher3/touch/AbstractStateChangeTouchController.java` 文件的如下代码：

    ```diff
    @@ -91,6 +91,12 @@ public abstract class AbstractStateChangeTouchController
                 if (mNoIntercept) {
                     return false;
                 }
    +                       
    +            // Add Launcher3 Style Switch add by qty {{&&
    +                       if (android.provider.Settings.System.getInt(mLauncher.getContentResolver(), "launcher_style", 0) == 1) {
    +                               return false;
    +                       }
    +            // &&}}
     
                 // Now figure out which direction scroll events the controller will start
                 // calling the callbacks.
    @@ -115,6 +121,12 @@ public abstract class AbstractStateChangeTouchController
                 return false;
             }
     
    +        // Add Launcher3 Style Switch add by qty {{&&
    +               if (android.provider.Settings.System.getInt(mLauncher.getContentResolver(), "launcher_style", 0) == 1) {
    +                       return false;
    +               }
    +        // &&}}
    +
             onControllerTouchEvent(ev);
             return mDetector.isDraggingOrSettling();
         }
    ```

21. 修改 `sys/vendor/partner_gms/apps/apps/SearchLauncher/res/xml/launcher_preferences.xml` 文件的如下代码：

    ```diff
    @@ -50,10 +50,18 @@
             android:title="@string/title_show_google_app"/>
     
         <SwitchPreference
             android:defaultValue="false"
             android:key="pref_allowRotation"
             android:persistent="true"
             android:summary="@string/allow_rotation_desc"
             android:title="@string/allow_rotation_title"/>
     
    +    <!-- Start Add Launcher3 Style Switch add by qty -->
    +    <androidx.preference.PreferenceScreen
    +        android:key="pref_launcher_style"
    +        android:title="@string/launcher_style_title"
    +        android:summary="@string/launcher_style_summary"
    +        android:fragment="com.android.launcher3.settings.LauncherStyleFragment"
    +        android:persistent="true" />
    +    <!-- End Add Launcher3 Style Switch add by qty -->
     </androidx.preference.PreferenceScreen>
    ```

22. 新增 `sys/packages/apps/Launcher3/res/layout/preference_radio.xml` 文件，文件内容如下：

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <!-- Copyright (C) 2018 The Android Open Source Project
    
         Licensed under the Apache License, Version 2.0 (the "License");
         you may not use this file except in compliance with the License.
         You may obtain a copy of the License at
    
              http://www.apache.org/licenses/LICENSE-2.0
    
         Unless required by applicable law or agreed to in writing, software
         distributed under the License is distributed on an "AS IS" BASIS,
         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
         See the License for the specific language governing permissions and
         limitations under the License.
    -->
    <!-- This file is copied from preference_app.xml with modification to
         support widget on the opposite side horizontally -->
    <LinearLayout
        xmlns:android="http://schemas.android.com/apk/res/android"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:background="?android:attr/selectableItemBackground"
        android:gravity="center_vertical"
        android:minHeight="?android:attr/listPreferredItemHeightSmall"
        android:paddingEnd="?android:attr/listPreferredItemPaddingEnd">
    
        <LinearLayout
            android:id="@android:id/widget_frame"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:minWidth="56dp"
            android:layout_marginEnd="16dp"
            android:orientation="vertical" />
    
        <LinearLayout
            android:id="@+id/icon_frame"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:gravity="center_vertical"
            android:minWidth="32dp"
            android:orientation="horizontal"
            android:layout_marginEnd="16dp"
            android:paddingTop="4dp"
            android:paddingBottom="4dp">
            <androidx.preference.internal.PreferenceImageView
                android:id="@android:id/icon"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:maxWidth="@dimen/secondary_app_icon_size"
                android:maxHeight="@dimen/secondary_app_icon_size" />
        </LinearLayout>
    
        <LinearLayout
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:orientation="vertical"
            android:paddingTop="16dp"
            android:paddingBottom="16dp">
    
            <TextView android:id="@android:id/title"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:singleLine="true"
                      android:textAppearance="@style/TextAppearance.TileTitle"
                      android:ellipsize="marquee"
                      android:fadingEdge="horizontal" />
    
            <LinearLayout
                android:id="@+id/summary_container"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:visibility="gone">
                <TextView android:id="@android:id/summary"
                          android:layout_width="0dp"
                          android:layout_height="wrap_content"
                          android:layout_weight="1"
                          android:textAppearance="@style/TextAppearance.Small"
                          android:textAlignment="viewStart"
                          android:textColor="?android:attr/textColorSecondary" />
    
                <TextView android:id="@+id/appendix"
                          android:layout_width="0dp"
                          android:layout_height="wrap_content"
                          android:layout_weight="1"
                          android:textAppearance="@style/TextAppearance.Small"
                          android:textAlignment="viewEnd"
                          android:textColor="?android:attr/textColorSecondary"
                          android:maxLines="1"
                          android:ellipsize="end" />
            </LinearLayout>
            <ProgressBar
                android:id="@android:id/progress"
                style="?android:attr/progressBarStyleHorizontal"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_marginTop="4dp"
                android:max="100"
                android:visibility="gone" />
        </LinearLayout>
    
    </LinearLayout>
    ```

23. 新增 `sys/packages/apps/Launcher3/res/layout/preference_widget_radiobutton.xml` 文件，文件内容如下：

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <!-- Copyright (C) 2006 The Android Open Source Project
    
         Licensed under the Apache License, Version 2.0 (the "License");
         you may not use this file except in compliance with the License.
         You may obtain a copy of the License at
    
              http://www.apache.org/licenses/LICENSE-2.0
    
         Unless required by applicable law or agreed to in writing, software
         distributed under the License is distributed on an "AS IS" BASIS,
         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
         See the License for the specific language governing permissions and
         limitations under the License.
    -->
    
    <!-- Layout used by CheckBoxPreference for the checkbox style. This is inflated
         inside android.R.layout.preference. -->
    <RadioButton xmlns:android="http://schemas.android.com/apk/res/android"
        android:id="@android:id/checkbox"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_gravity="center"
        android:background="@null"
        android:focusable="false"
        android:clickable="false" />
    ```

24. 新增 `sys/packages/apps/Launcher3/res/values/strings-mmi.xml` 文件，文件内容如下：

    ```xml
    <?xml version="1.0" encoding="utf-8"?><!--
    /*
    * Copyright (C) 2008 The Android Open Source Project
    *
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    *      http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    */
    -->
    
    <resources xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
        <!-- Start Add Launcher3 Style Switch add by qty -->
        <string name="launcher_style_title">Launcher Style</string>
        <string name="launcher_style_summary">Choose Launcer Style</string>
        <string name="launcher_style_nomal">Standard Mode</string>
        <string name="launcher_style_drawer">Drawer Mode</string>
        <string name="item_unremoved">Item can not be removed in standard mode launcher</string>
        <!-- End Add Launcher3 Style Switch add by qty -->
    </resources>
    ```

25. 新增 `sys/packages/apps/Launcher3/res/values/styles_ext.xml` 文件，文件内容如下：

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <resources>
    
        <!-- add for all apps bg transparent icon -->
        <style name="TransBgAppIcon" parent="BaseIcon.Workspace">
            <item name="android:textColor">?attr/workspaceTextColor</item>
            <item name="android:textSize">@dimen/drop_target_text_size</item>
        </style>
        
    </resources>
    ```

26. 新增 `sys/packages/apps/Launcher3/res/xml/launcher_style.xml` 文件，文件内容如下：

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <!-- Copyright (C) 2017 The Android Open Source Project
    
         Licensed under the Apache License, Version 2.0 (the "License");
         you may not use this file except in compliance with the License.
         You may obtain a copy of the License at
    
              http://www.apache.org/licenses/LICENSE-2.0
    
         Unless required by applicable law or agreed to in writing, software
         distributed under the License is distributed on an "AS IS" BASIS,
         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
         See the License for the specific language governing permissions and
         limitations under the License.
    -->
    
    <androidx.preference.PreferenceScreen
        xmlns:android="http://schemas.android.com/apk/res/android"
        android:title="@string/launcher_style_title">
    
            <com.android.launcher3.settings.RadioButtonPreference
                android:key="launcher_style_drawer"
                android:title="@string/launcher_style_drawer" />
            <com.android.launcher3.settings.RadioButtonPreference
                android:key="launcher_style_nomal"
                android:title="@string/launcher_style_nomal" />
    
    </androidx.preference.PreferenceScreen>
    ```

27. 新增 `sys/packages/apps/Launcher3/src/com/android/launcher3/beautifyui/BaseController.java` 文件，文件内容如下：

    ```java
    package com.android.launcher3.beautifyui;
    
    import android.content.Context;
    
    import java.io.FileDescriptor;
    import java.io.PrintWriter;
    
    
    public class BaseController {
        private static final String TAG = "BaseController";
    
        protected final Context mContext;
    
        public BaseController(Context context) {
            mContext = context;
        }
    
        public void dumpState(String prefix, FileDescriptor fd, PrintWriter writer, boolean dumpAll) {
    
        }
    }
    ```

28. 新增 `sys/packages/apps/Launcher3/src/com/android/launcher3/beautifyui/HotseatController.java` 文件，文件内容如下：

    ```java
    package com.android.launcher3.beautifyui;
    
    import android.content.Context;
    import android.view.MotionEvent;
    import android.view.View;
    import android.util.Log;
    
    import com.android.launcher3.BubbleTextView;
    import com.android.launcher3.CellLayout;
    import com.android.launcher3.Hotseat;
    import com.android.launcher3.Launcher;
    import com.android.launcher3.LauncherAppState;
    import com.android.launcher3.LauncherSettings;
    import com.android.launcher3.folder.Folder;
    import com.android.launcher3.folder.FolderIcon;
    import com.android.launcher3.model.data.ItemInfo;
    import android.graphics.Point;
    import android.graphics.Rect;
    import com.android.launcher3.beautifyui.BaseController;
    import com.android.launcher3.beautifyui.LauncherAppMonitor;
    
    import java.util.ArrayList;
    
    
    public class HotseatController extends BaseController {
        private static final String TAG = "HotseatController";
    
        private static final int INVALID = -1;
    
        private boolean mDelayClearEmptyGridFlag = false;
    
        private CellLayout.CellInfo mBackupDragInfo = null;
        private LauncherAppMonitor mMonitor;
    
        public HotseatController(Context context, LauncherAppMonitor monitor) {
            super(context);
            mMonitor = monitor;
        }
    
        public boolean isFull(Launcher launcher) {
            if (launcher == null) {
                return false;
            }
    
            Hotseat hs = launcher.getHotseat();
            int gridCount = getGridCount(launcher);
            for (int i = 0; i < gridCount; i++) {
                int cx = hs.getCellXFromOrder(i);
                int cy = hs.getCellYFromOrder(i);
                if (!hs.isOccupied(cx, cy)) {
                    return false;
                }
            }
            return true;
        }
    
        public boolean clearEmptyGrid(Launcher launcher) {
            if (launcher == null) {
                Log.d(TAG, "launcher is null, clear empty grid failed.");
                return false;
            }
    
            if (isFull(launcher)) {
                Log.d(TAG, "there are no empty grid in hotseat, no need to clear.");
                return false;
            }
    
            if (mDelayClearEmptyGridFlag) {
                Log.d(TAG, "mDelayClearEmptyGridFlag is true, to clear empty when it is false.");
                return false;
            }
    
            ArrayList<View> views = backupHotseatChildren(launcher);
            if (views.size() == 0) {
                return false;
            }
    
            Hotseat hs = launcher.getHotseat();
            boolean isLandscape = hs.mHasVerticalHotseat;
            int count = views.size();
            int countX = isLandscape ? 1 : Math.max(count, 1);
            int countY = isLandscape ? Math.max(count, 1) : 1;
            hs.removeAllViews();
            hs.setGridSize(countX, countY);
            for (int i = 0; i < count; i++) {
                if (!addViewToHotseat(launcher, views.get(i), i)) {
                    Log.e(TAG, "failed to add view to hotseat, rank:" + i);
                }
            }
    
            updateFolderIconLeaveBehind(launcher);
    
            return true;
        }
    
        private void updateFolderIconLeaveBehind(Launcher launcher) {
            Folder folder = Folder.getOpen(launcher);
            if (folder != null && folder.mInfo.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT) {
                folder.getFolderIcon().drawLeaveBehindIfExists();
            }
        }
    
        public boolean insertEmptyGrid(Launcher launcher, int index) {
            if (launcher == null) {
                Log.d(TAG, "launcher is null, insert empty grid failed.");
                return false;
            }
    
            if (!canInsert(launcher)) {
                Log.d(TAG, "achieve maximum limit, can not insert empty grid.");
                return false;
            }
    
            if (!isFull(launcher)) {
                Log.d(TAG, "the hotseat has empty grid, can not insert empty grid.");
                return false;
            }
    
            ArrayList<View> views = backupHotseatChildren(launcher);
            Hotseat hs = launcher.getHotseat();
            final boolean isLandscape = hs.mHasVerticalHotseat;
            int newCount = views.size() + 1;
            int countX = isLandscape ? 1 : newCount;
            int countY = isLandscape ? newCount : 1;
            hs.removeAllViews();
            hs.setGridSize(countX, countY);
            for (int i = 0; i < views.size(); i++) {
                View view = views.get(i);
                if (i < index) {
                    addViewToHotseat(launcher, view, i);
                } else {
                    addViewToHotseat(launcher, view, i + 1);
                }
    
                if (view.getTag() instanceof ItemInfo) {
                    launcher.getModelWriter().updateItemInDatabase((ItemInfo) view.getTag());
                }
            }
            return true;
        }
    
        private ArrayList<View> backupHotseatChildren(Launcher launcher) {
            Hotseat hs = launcher.getHotseat();
            int gridCount = getGridCount(launcher);
            ArrayList<View> views = new ArrayList<>();
            for (int i = 0; i < gridCount; i++) {
                int cx = hs.getCellXFromOrder(i);
                int cy = hs.getCellYFromOrder(i);
                View v = hs.getShortcutsAndWidgets().getChildAt(cx, cy);
                if (hs.isOccupied(cx, cy)) {
                    if (v != null) {
                        if (true) {
                            Log.d(TAG, "backup child:" + i);
                        }
                        views.add(v);
                    }
                }
            }
            return views;
        }
    
        public boolean addViewToHotseat(Launcher launcher, View v, int rank) {
            Hotseat hs = launcher.getHotseat();
            if (v != null && rank < getGridCount(launcher)) {
                int cellX = hs.getCellXFromOrder(rank);
                int cellY = hs.getCellYFromOrder(rank);
                if (v.getTag() instanceof ItemInfo) {
                    CellLayout.LayoutParams lp = new CellLayout.LayoutParams(cellX, cellY, 1, 1);
                    if (hs.addViewToCellLayout(v, -1, v.getId(), lp, true)) {
                        ((ItemInfo)v.getTag()).screenId = rank;
                        if (true) {
                            Log.d(TAG, "update " + ((ItemInfo)v.getTag()).title + " to:" + rank);
                        }
                        return true;
                    }
                }
            }
            return false;
        }
    
        public void resetDragCell(Launcher launcher, CellLayout.CellInfo cellInfo) {
            if (cellInfo == null || cellInfo.cell == null) {
                if (cellInfo != null) {
                    Log.d(TAG, "cell is null, can not reset cell to original position.");
                }
                return;
            }
    
            if (cellInfo.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT) {
                View v = cellInfo.cell;
                Hotseat hs = launcher.getHotseat();
                int gridCount = getGridCount(launcher);
                CellLayout.LayoutParams lp = (CellLayout.LayoutParams) v.getLayoutParams();
                int index = getOrderInHotseat(launcher, lp.cellX, lp.cellY, gridCount + 1);
                if (index >= gridCount) {
                    insertEmptyGrid(launcher, gridCount);
                } else {
                    int cx = hs.getCellXFromOrder(index);
                    int cy = hs.getCellYFromOrder(index);
                    if (hs.isOccupied(cx, cy)) {
                        insertEmptyGrid(launcher, index);
                    }
                }
    
                if (addViewToHotseat(launcher, v, index)) {
                    v.setVisibility(View.VISIBLE);
                    Log.d(TAG, "resetDragCell to :" + index);
                }
            }
        }
    
        public int calculateBestIndex(Launcher launcher, float[] dragViewVisualCenterint,
                                      int findCellX, int findCellY) {
            Hotseat hs = launcher.getHotseat();
            int index = getOrderInHotseat(launcher, findCellX, findCellY);
            int[] cellCenter = new int[2];
            hs.cellToCenterPoint(findCellX, findCellY, cellCenter);
            boolean isDragInEndArea = hs.mHasVerticalHotseat ?
                    dragViewVisualCenterint[1] < cellCenter[1] : dragViewVisualCenterint[0] > cellCenter[0];
            return isDragInEndArea ? index + 1 : index;
        }
    
        public void resetGridIfNeeded(Launcher launcher, int index) {
            if (launcher == null) {
                return;
            }
    
            if (!isCellOccupied(launcher)) {
                insertEmptyGrid(launcher, index);
            }
        }
    
        public boolean isCellOccupied(Launcher launcher) {
            if (launcher == null) {
                return false;
            }
    
            Hotseat hs = launcher.getHotseat();
            int gridCount = getGridCount(launcher);
            if (gridCount == 1) {
                if (!hs.isOccupied(0, 0)) {
                    return true;
                }
            }
            return false;
        }
    
        public boolean isNeedInterceptHotseatTouch(MotionEvent event, View view) {
            boolean needIntercept = false;
            if (view != null && view.getTag() instanceof ItemInfo) {
                if (((ItemInfo) view.getTag()).container == LauncherSettings.Favorites.CONTAINER_HOTSEAT) {
                    int iconSize = 0;
                    if (view instanceof FolderIcon) {
                        iconSize = LauncherAppState.getIDP(mContext).getDeviceProfile(mContext).folderIconSizePx;
                    } else if (view instanceof BubbleTextView) {
                        iconSize = ((BubbleTextView) view).getIconSize();
                    }
                    // we'll intercept touch event when touch in blank area in hotseat.
                    needIntercept = !getIconRect(iconSize, view)
                            .contains((int) event.getX() + view.getScrollX(),
                                    (int) event.getY() + view.getScrollY());
                }
            }
            return needIntercept;
        }
    
        public static Rect getIconRect(int iconSize, View view) {
            Point center = new Point(view.getScrollX() + (view.getWidth() >> 1),
                    view.getScrollY() + view.getPaddingTop() + (iconSize >> 1));
            Rect iconRect = new Rect();
    
            iconRect.left = center.x - (iconSize >> 1);
            iconRect.top = center.y - (iconSize >> 1);
            iconRect.right = iconRect.left + iconSize;
            iconRect.bottom = iconRect.top + iconSize;
            return iconRect;
        }
    
        /* Get the orientation invariant order of the item in the hotseat for persistence. */
        public int getOrderInHotseat(Launcher launcher, int x, int y) {
            return getOrderInHotseat(launcher, x, y, getGridCount(launcher));
        }
    
        /* Get the orientation invariant order of the item in the hotseat for persistence. */
        public int getOrderInHotseat(Launcher launcher, int x, int y, int gridCount) {
            if (launcher == null) {
                Log.d(TAG, "launcher is null, can not get order in hotseat.");
                return INVALID;
            }
    
            return launcher.getHotseat().mHasVerticalHotseat ? (gridCount - y - 1) : x;
        }
    
        public int getGridCount(Launcher launcher) {
            if (launcher == null) {
                Log.d(TAG, "launcher is null, can not get grid count.");
                return INVALID;
            }
    
            Hotseat hs = launcher.getHotseat();
            return hs.mHasVerticalHotseat ? hs.getCountY() : hs.getCountX();
        }
    
        public boolean canInsert(Launcher launcher) {
            int gridCount = getGridCount(launcher);
            return gridCount < 4;//launcher.getDeviceProfile().inv.numHotseatIcons;
        }
    
        public void backupDragInfo(CellLayout.CellInfo cellInfo) {
            mBackupDragInfo = cellInfo;
        }
    
        public CellLayout.CellInfo getBackupDragInfo () {
            return mBackupDragInfo;
        }
    
        public void setDelayClearEmptyGridFlag(boolean falg) {
            mDelayClearEmptyGridFlag = falg;
        }
    }
    ```

29. 新增 `sys/packages/apps/Launcher3/src/com/android/launcher3/beautifyui/LauncherAppMonitor.java` 文件，文件内容如下：

    ```java
    package com.android.launcher3.beautifyui;
    
    import android.content.Context;
    import android.view.MotionEvent;
    import android.view.View;
    import android.util.Log;
    
    import com.android.launcher3.BubbleTextView;
    import com.android.launcher3.CellLayout;
    import com.android.launcher3.Hotseat;
    import com.android.launcher3.Launcher;
    import com.android.launcher3.LauncherAppState;
    import com.android.launcher3.LauncherSettings;
    import com.android.launcher3.folder.Folder;
    import com.android.launcher3.folder.FolderIcon;
    import com.android.launcher3.model.data.ItemInfo;
    import android.graphics.Point;
    import android.graphics.Rect;
    import com.android.launcher3.beautifyui.BaseController;
    import com.android.launcher3.beautifyui.LauncherAppMonitor;
    
    import java.util.ArrayList;
    
    
    public class HotseatController extends BaseController {
        private static final String TAG = "HotseatController";
    
        private static final int INVALID = -1;
    
        private boolean mDelayClearEmptyGridFlag = false;
    
        private CellLayout.CellInfo mBackupDragInfo = null;
        private LauncherAppMonitor mMonitor;
    
        public HotseatController(Context context, LauncherAppMonitor monitor) {
            super(context);
            mMonitor = monitor;
        }
    
        public boolean isFull(Launcher launcher) {
            if (launcher == null) {
                return false;
            }
    
            Hotseat hs = launcher.getHotseat();
            int gridCount = getGridCount(launcher);
            for (int i = 0; i < gridCount; i++) {
                int cx = hs.getCellXFromOrder(i);
                int cy = hs.getCellYFromOrder(i);
                if (!hs.isOccupied(cx, cy)) {
                    return false;
                }
            }
            return true;
        }
    
        public boolean clearEmptyGrid(Launcher launcher) {
            if (launcher == null) {
                Log.d(TAG, "launcher is null, clear empty grid failed.");
                return false;
            }
    
            if (isFull(launcher)) {
                Log.d(TAG, "there are no empty grid in hotseat, no need to clear.");
                return false;
            }
    
            if (mDelayClearEmptyGridFlag) {
                Log.d(TAG, "mDelayClearEmptyGridFlag is true, to clear empty when it is false.");
                return false;
            }
    
            ArrayList<View> views = backupHotseatChildren(launcher);
            if (views.size() == 0) {
                return false;
            }
    
            Hotseat hs = launcher.getHotseat();
            boolean isLandscape = hs.mHasVerticalHotseat;
            int count = views.size();
            int countX = isLandscape ? 1 : Math.max(count, 1);
            int countY = isLandscape ? Math.max(count, 1) : 1;
            hs.removeAllViews();
            hs.setGridSize(countX, countY);
            for (int i = 0; i < count; i++) {
                if (!addViewToHotseat(launcher, views.get(i), i)) {
                    Log.e(TAG, "failed to add view to hotseat, rank:" + i);
                }
            }
    
            updateFolderIconLeaveBehind(launcher);
    
            return true;
        }
    
        private void updateFolderIconLeaveBehind(Launcher launcher) {
            Folder folder = Folder.getOpen(launcher);
            if (folder != null && folder.mInfo.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT) {
                folder.getFolderIcon().drawLeaveBehindIfExists();
            }
        }
    
        public boolean insertEmptyGrid(Launcher launcher, int index) {
            if (launcher == null) {
                Log.d(TAG, "launcher is null, insert empty grid failed.");
                return false;
            }
    
            if (!canInsert(launcher)) {
                Log.d(TAG, "achieve maximum limit, can not insert empty grid.");
                return false;
            }
    
            if (!isFull(launcher)) {
                Log.d(TAG, "the hotseat has empty grid, can not insert empty grid.");
                return false;
            }
    
            ArrayList<View> views = backupHotseatChildren(launcher);
            Hotseat hs = launcher.getHotseat();
            final boolean isLandscape = hs.mHasVerticalHotseat;
            int newCount = views.size() + 1;
            int countX = isLandscape ? 1 : newCount;
            int countY = isLandscape ? newCount : 1;
            hs.removeAllViews();
            hs.setGridSize(countX, countY);
            for (int i = 0; i < views.size(); i++) {
                View view = views.get(i);
                if (i < index) {
                    addViewToHotseat(launcher, view, i);
                } else {
                    addViewToHotseat(launcher, view, i + 1);
                }
    
                if (view.getTag() instanceof ItemInfo) {
                    launcher.getModelWriter().updateItemInDatabase((ItemInfo) view.getTag());
                }
            }
            return true;
        }
    
        private ArrayList<View> backupHotseatChildren(Launcher launcher) {
            Hotseat hs = launcher.getHotseat();
            int gridCount = getGridCount(launcher);
            ArrayList<View> views = new ArrayList<>();
            for (int i = 0; i < gridCount; i++) {
                int cx = hs.getCellXFromOrder(i);
                int cy = hs.getCellYFromOrder(i);
                View v = hs.getShortcutsAndWidgets().getChildAt(cx, cy);
                if (hs.isOccupied(cx, cy)) {
                    if (v != null) {
                        if (true) {
                            Log.d(TAG, "backup child:" + i);
                        }
                        views.add(v);
                    }
                }
            }
            return views;
        }
    
        public boolean addViewToHotseat(Launcher launcher, View v, int rank) {
            Hotseat hs = launcher.getHotseat();
            if (v != null && rank < getGridCount(launcher)) {
                int cellX = hs.getCellXFromOrder(rank);
                int cellY = hs.getCellYFromOrder(rank);
                if (v.getTag() instanceof ItemInfo) {
                    CellLayout.LayoutParams lp = new CellLayout.LayoutParams(cellX, cellY, 1, 1);
                    if (hs.addViewToCellLayout(v, -1, v.getId(), lp, true)) {
                        ((ItemInfo)v.getTag()).screenId = rank;
                        if (true) {
                            Log.d(TAG, "update " + ((ItemInfo)v.getTag()).title + " to:" + rank);
                        }
                        return true;
                    }
                }
            }
            return false;
        }
    
        public void resetDragCell(Launcher launcher, CellLayout.CellInfo cellInfo) {
            if (cellInfo == null || cellInfo.cell == null) {
                if (cellInfo != null) {
                    Log.d(TAG, "cell is null, can not reset cell to original position.");
                }
                return;
            }
    
            if (cellInfo.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT) {
                View v = cellInfo.cell;
                Hotseat hs = launcher.getHotseat();
                int gridCount = getGridCount(launcher);
                CellLayout.LayoutParams lp = (CellLayout.LayoutParams) v.getLayoutParams();
                int index = getOrderInHotseat(launcher, lp.cellX, lp.cellY, gridCount + 1);
                if (index >= gridCount) {
                    insertEmptyGrid(launcher, gridCount);
                } else {
                    int cx = hs.getCellXFromOrder(index);
                    int cy = hs.getCellYFromOrder(index);
                    if (hs.isOccupied(cx, cy)) {
                        insertEmptyGrid(launcher, index);
                    }
                }
    
                if (addViewToHotseat(launcher, v, index)) {
                    v.setVisibility(View.VISIBLE);
                    Log.d(TAG, "resetDragCell to :" + index);
                }
            }
        }
    
        public int calculateBestIndex(Launcher launcher, float[] dragViewVisualCenterint,
                                      int findCellX, int findCellY) {
            Hotseat hs = launcher.getHotseat();
            int index = getOrderInHotseat(launcher, findCellX, findCellY);
            int[] cellCenter = new int[2];
            hs.cellToCenterPoint(findCellX, findCellY, cellCenter);
            boolean isDragInEndArea = hs.mHasVerticalHotseat ?
                    dragViewVisualCenterint[1] < cellCenter[1] : dragViewVisualCenterint[0] > cellCenter[0];
            return isDragInEndArea ? index + 1 : index;
        }
    
        public void resetGridIfNeeded(Launcher launcher, int index) {
            if (launcher == null) {
                return;
            }
    
            if (!isCellOccupied(launcher)) {
                insertEmptyGrid(launcher, index);
            }
        }
    
        public boolean isCellOccupied(Launcher launcher) {
            if (launcher == null) {
                return false;
            }
    
            Hotseat hs = launcher.getHotseat();
            int gridCount = getGridCount(launcher);
            if (gridCount == 1) {
                if (!hs.isOccupied(0, 0)) {
                    return true;
                }
            }
            return false;
        }
    
        public boolean isNeedInterceptHotseatTouch(MotionEvent event, View view) {
            boolean needIntercept = false;
            if (view != null && view.getTag() instanceof ItemInfo) {
                if (((ItemInfo) view.getTag()).container == LauncherSettings.Favorites.CONTAINER_HOTSEAT) {
                    int iconSize = 0;
                    if (view instanceof FolderIcon) {
                        iconSize = LauncherAppState.getIDP(mContext).getDeviceProfile(mContext).folderIconSizePx;
                    } else if (view instanceof BubbleTextView) {
                        iconSize = ((BubbleTextView) view).getIconSize();
                    }
                    // we'll intercept touch event when touch in blank area in hotseat.
                    needIntercept = !getIconRect(iconSize, view)
                            .contains((int) event.getX() + view.getScrollX(),
                                    (int) event.getY() + view.getScrollY());
                }
            }
            return needIntercept;
        }
    
        public static Rect getIconRect(int iconSize, View view) {
            Point center = new Point(view.getScrollX() + (view.getWidth() >> 1),
                    view.getScrollY() + view.getPaddingTop() + (iconSize >> 1));
            Rect iconRect = new Rect();
    
            iconRect.left = center.x - (iconSize >> 1);
            iconRect.top = center.y - (iconSize >> 1);
            iconRect.right = iconRect.left + iconSize;
            iconRect.bottom = iconRect.top + iconSize;
            return iconRect;
        }
    
        /* Get the orientation invariant order of the item in the hotseat for persistence. */
        public int getOrderInHotseat(Launcher launcher, int x, int y) {
            return getOrderInHotseat(launcher, x, y, getGridCount(launcher));
        }
    
        /* Get the orientation invariant order of the item in the hotseat for persistence. */
        public int getOrderInHotseat(Launcher launcher, int x, int y, int gridCount) {
            if (launcher == null) {
                Log.d(TAG, "launcher is null, can not get order in hotseat.");
                return INVALID;
            }
    
            return launcher.getHotseat().mHasVerticalHotseat ? (gridCount - y - 1) : x;
        }
    
        public int getGridCount(Launcher launcher) {
            if (launcher == null) {
                Log.d(TAG, "launcher is null, can not get grid count.");
                return INVALID;
            }
    
            Hotseat hs = launcher.getHotseat();
            return hs.mHasVerticalHotseat ? hs.getCountY() : hs.getCountX();
        }
    
        public boolean canInsert(Launcher launcher) {
            int gridCount = getGridCount(launcher);
            return gridCount < 4;//launcher.getDeviceProfile().inv.numHotseatIcons;
        }
    
        public void backupDragInfo(CellLayout.CellInfo cellInfo) {
            mBackupDragInfo = cellInfo;
        }
    
        public CellLayout.CellInfo getBackupDragInfo () {
            return mBackupDragInfo;
        }
    
        public void setDelayClearEmptyGridFlag(boolean falg) {
            mDelayClearEmptyGridFlag = falg;
        }
    }
    ```

30. 新增 `sys/packages/apps/Launcher3/src/com/android/launcher3/beautifyui/LauncherAppMonitorCallback.java` 文件，文件内容如下：

    ```java
    package com.android.launcher3.beautifyui;
    
    import android.content.Context;
    import android.content.Intent;
    import android.content.pm.ShortcutInfo;
    import android.database.sqlite.SQLiteDatabase;
    import android.os.UserHandle;
    
    import com.android.launcher3.BaseDraggingActivity;
    import com.android.launcher3.Launcher;
    import com.android.launcher3.LauncherState;
    import com.android.launcher3.model.data.AppInfo;
    
    import java.io.FileDescriptor;
    import java.io.PrintWriter;
    import java.util.ArrayList;
    import java.util.List;
    
    public class LauncherAppMonitorCallback {
        //Launcher activity Callbacks
        public void onLauncherPreCreate(Launcher launcher) { }
    
        public void onLauncherCreated() { }
    
        public void onLauncherPreResume() { }
    
        public void onLauncherResumed() { }
    
        public void onLauncherStart() { }
    
        public void onLauncherStop() { }
    
        public void onLauncherPrePaused() { }
    
        public void onLauncherPaused() { }
    
        public void onLauncherDestroy() { }
    
        public void onLauncherRequestPermissionsResult(int requestCode, String[] permissions,
                                                       int[] grantResults) { }
    
        public void onSettingsActivityRequestPermissionsResult(int requestCode, String[] permissions,
                                                       int[] grantResults) { }
    
        public void onLauncherFocusChanged(boolean hasFocus) { }
    
        public void onQuickstepLauncherStart() { }
    
        public void onRecentsActivityCreate(BaseDraggingActivity activity) { }
    
        public void onRecentsActivityStart() { }
    
        public void onHomeIntent() { }
    
        public void onBindingWorkspaceFinish () { }
    
        public void onBindingAllAppFinish (AppInfo[] apps) { }
    
        //Launcher app Callbacks
        public void onAppCreated(Context context) { }
    
        public void onReceive(Intent intent) { }
    
        public void onUIConfigChanged() { }
    
        public void onThemeChanged() { }
    
        public void onGridChanged() { }
    
        public void onAppSharedPreferenceChanged(String key) { }
    
        public void onPackageRemoved(String packageName, UserHandle user) { }
    
        public void onPackageAdded(String packageName, UserHandle user) { }
    
        public void onPackageChanged(String packageName, UserHandle user) { }
    
        public void onPackagesAvailable(String[] packageNames, UserHandle user, boolean replacing) { }
    
        public void onPackagesUnavailable(String[] packageNames, UserHandle user, boolean replacing) { }
    
        public void onPackagesSuspended(String[] packageNames, UserHandle user) { }
    
        public void onPackagesUnsuspended(String[] packageNames, UserHandle user) { }
    
        public void onPackagesUpdated(String[] packageNames, UserHandle user, int op) { }
    
        public void onShortcutsChanged(String packageName, List<ShortcutInfo> shortcuts, UserHandle user) { }
    
        public void onAllAppsListUpdated(List<AppInfo> apps) { }
    
        public void onLauncherLocaleChanged() { }
    
        public void onLauncherOrientationChanged () { }
    
        public void onLauncherScreensizeChanged() { }
    
        public void onLoadAllAppsEnd(ArrayList<AppInfo> apps) { }
    
        public void onHomeStyleChanged(String style) { }
    
        //Launcher database callbacks
        public void onDbUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) { }
    
        public void onStateSetStart(LauncherState toState) { }
    
        public void onStateSetEnd(LauncherState toState) { }
    
        public void onTaskStackUpdated(boolean hasTask) { }
    
        public void onOrientationStateChanged() { }
    
        public void dump(String prefix, FileDescriptor fd, PrintWriter w, boolean dumpAll) { }
    }
    ```

31. 新增 `sys/packages/apps/Launcher3/src/com/android/launcher3/settings/LauncherStyleFragment.java` 文件，文件内容如下：

    ```java
    /*
     * Copyright (C) 2018 The Android Open Source Project
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *      http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
    package com.android.launcher3.settings;
    
    import android.annotation.TargetApi;
    import android.os.Build;
    import android.os.Bundle;
    import android.provider.Settings;
    import com.android.launcher3.R;
    import androidx.preference.Preference;
    import androidx.preference.PreferenceCategory;
    import androidx.preference.PreferenceDataStore;
    import androidx.preference.PreferenceFragmentCompat;
    import androidx.preference.PreferenceScreen;
    import androidx.preference.PreferenceViewHolder;
    import androidx.preference.SwitchPreference;
    
    /**
     * Dev-build only UI allowing developers to toggle flag settings and plugins.
     * See {@link FeatureFlags}.
     */
    @TargetApi(Build.VERSION_CODES.O)
    public class LauncherStyleFragment extends PreferenceFragmentCompat 
    		implements RadioButtonPreference.OnClickListener {
    
        private static final String KEY_STYLE_DRAWER = "launcher_style_drawer";
    	private static final String KEY_STYLE_NOMAL = "launcher_style_nomal";
    	private RadioButtonPreference mDrawer;
    	private RadioButtonPreference mNomal;
    	private int mCurrentMode;
    	
        @Override
        public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
    		setPreferencesFromResource(R.xml.launcher_style, rootKey);
    		mDrawer = (RadioButtonPreference)findPreference(KEY_STYLE_DRAWER);
    		mNomal = (RadioButtonPreference)findPreference(KEY_STYLE_NOMAL);
    		mDrawer.setOnClickListener(this);
    		mNomal.setOnClickListener(this);
    		int mode = Settings.System.getInt(getContext().getContentResolver(), "launcher_style", 0);
    		mDrawer.setChecked(mode == 0 ? true : false);
    		mNomal.setChecked(mode == 1 ? true : false);
    		mCurrentMode = mode;
        }
    	
    	@Override
        public void onRadioButtonClicked(RadioButtonPreference preference) {
    		if (preference.isChecked()) {
    			return;
    		}
    		if (mDrawer == preference) {
    			Settings.System.putInt(getContext().getContentResolver(), "launcher_style", 0);
    			Settings.System.putInt(getContext().getContentResolver(), "launcher_style_change", 1);
    			mCurrentMode = 0;
    		} else if (mNomal == preference) {
    			Settings.System.putInt(getContext().getContentResolver(), "launcher_style", 1);
    			Settings.System.putInt(getContext().getContentResolver(), "launcher_style_change", 1);
    			mCurrentMode = 1;
    		}
    		mDrawer.setChecked(mCurrentMode == 0 ? true : false);
    		mNomal.setChecked(mCurrentMode == 1 ? true : false);
    		getActivity().onBackPressed();
    	}
    
    }
    ```

32. 新增 `sys/packages/apps/Launcher3/src/com/android/launcher3/settings/RadioButtonPreference.java` 文件，文件内容如下：

    ```java
    /*
     * Copyright (C) 2017 The Android Open Source Project
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *      http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
    
    package com.android.launcher3.settings;
    
    import android.content.Context;
    import android.text.TextUtils;
    import android.util.AttributeSet;
    import android.view.View;
    import android.widget.TextView;
    
    import androidx.core.content.res.TypedArrayUtils;
    import androidx.preference.CheckBoxPreference;
    import androidx.preference.PreferenceViewHolder;
    
    import com.android.launcher3.R;
    
    /**
     * Check box preference with check box replaced by radio button.
     *
     * Functionally speaking, it's actually a CheckBoxPreference. We only modified
     * the widget to RadioButton to make it "look like" a RadioButtonPreference.
     *
     * In other words, there's no "RadioButtonPreferenceGroup" in this
     * implementation. When you check one RadioButtonPreference, if you want to
     * uncheck all the other preferences, you should do that by code yourself.
     */
    public class RadioButtonPreference extends CheckBoxPreference {
        public interface OnClickListener {
           void onRadioButtonClicked(RadioButtonPreference emiter);
        }
    
        private OnClickListener mListener = null;
        private View appendix;
        private int appendixVisibility = -1;
    
        public RadioButtonPreference(Context context, AttributeSet attrs, int defStyle) {
            super(context, attrs, defStyle);
            setWidgetLayoutResource(R.layout.preference_widget_radiobutton);
            setLayoutResource(R.layout.preference_radio);
            setIconSpaceReserved(false);
        }
    
        public RadioButtonPreference(Context context, AttributeSet attrs) {
            this(context, attrs, TypedArrayUtils.getAttr(context,
                    androidx.preference.R.attr.preferenceStyle,
                    android.R.attr.preferenceStyle));
        }
    
        public RadioButtonPreference(Context context) {
            this(context, null);
        }
    
        public void setOnClickListener(OnClickListener listener) {
            mListener = listener;
        }
    
        @Override
        public void onClick() {
            if (mListener != null) {
                mListener.onRadioButtonClicked(this);
            }
        }
    
        @Override
        public void onBindViewHolder(PreferenceViewHolder view) {
            super.onBindViewHolder(view);
    
            View summaryContainer = view.findViewById(R.id.summary_container);
            if (summaryContainer != null) {
                summaryContainer.setVisibility(
                    TextUtils.isEmpty(getSummary()) ? View.GONE : View.VISIBLE);
                appendix = view.findViewById(R.id.appendix);
                if (appendix != null && appendixVisibility != -1) {
                    appendix.setVisibility(appendixVisibility);
                }
            }
    
            TextView title = (TextView) view.findViewById(android.R.id.title);
            if (title != null) {
                title.setSingleLine(false);
                title.setMaxLines(3);
            }
        }
    
        public void setAppendixVisibility(int visibility) {
            if (appendix != null) {
                appendix.setVisibility(visibility);
            }
            appendixVisibility = visibility;
        }
    }
    ```

    

