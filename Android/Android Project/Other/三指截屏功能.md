> 注意：下面修改代码不包括控制菜单，需要自行添加。

1. 修改 `frameworks/base/services/core/java/com/android/server/wm/SystemGesturesPointerEventListener.java` 文件如下代码：

   > 提示：添加下滑手势，在下滑手势中判断当前触摸手指数来出发截屏操作。

   ```diff
   @@ -81,6 +81,17 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
        private boolean mMouseHoveringAtEdge;
        private long mLastFlingTime;
    
   +    // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +    private static final int SWIPE_DOWN = 5;
   +    private int mPointer1Id;
   +    private int mPointer2Id;
   +    private int mPointer3Id;
   +    private float mDown1Y;
   +    private float mDown2Y;
   +    private float mDown3Y;
   +    private boolean isScreenshot;
   +    // &&}}
   +
        SystemGesturesPointerEventListener(Context context, Handler handler, Callbacks callbacks) {
            mContext = checkNull("context", context);
            mHandler = handler;
   @@ -189,11 +200,35 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
                            mCallbacks.onDebug();
                        }
                    }
   +                // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +                if (event.getPointerCount() == 3) {
   +                    mPointer1Id = event.getPointerId(0);
   +                    mPointer2Id = event.getPointerId(1);
   +                    mPointer3Id = event.getPointerId(2);
   +                    mDown1Y = event.getY(0);
   +                    mDown2Y = event.getY(1);
   +                    mDown3Y = event.getY(2);
   +                }
   +                // &&}}
                    break;
                case MotionEvent.ACTION_MOVE:
                    if (mSwipeFireable) {
   -                    final int swipe = detectSwipe(event);
   -                    mSwipeFireable = swipe == SWIPE_NONE;
   +                    // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +                    // final int swipe = detectSwipe(event);
   +                    // mSwipeFireable = swipe == SWIPE_NONE;
   +                    int swipe = SWIPE_NONE;
   +                    if (event.getPointerCount() == 3) {
   +                        float down1Y = getPointerY(event, mPointer1Id);
   +                        float down2Y = getPointerY(event, mPointer2Id);
   +                        float down3Y = getPointerY(event, mPointer3Id);
   +                        if ((down1Y - mDown1Y) > 200 && (down2Y - mDown2Y) > 200 && (down3Y - mDown3Y) > 200) {
   +                            swipe = SWIPE_DOWN;
   +                        }
   +                    } else {
   +                        swipe = detectSwipe(event);
   +                    }
   +                    // &&}}
   +                    mSwipeFireable = (swipe == SWIPE_NONE) || (swipe == SWIPE_FROM_TOP);
                        if (swipe == SWIPE_FROM_TOP) {
                            if (DEBUG) Slog.d(TAG, "Firing onSwipeFromTop");
                            mCallbacks.onSwipeFromTop();
   @@ -206,9 +241,14 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
                        } else if (swipe == SWIPE_FROM_LEFT) {
                            if (DEBUG) Slog.d(TAG, "Firing onSwipeFromLeft");
                            mCallbacks.onSwipeFromLeft();
   +                    // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +                    } else if (swipe == SWIPE_DOWN) {
   +                        mCallbacks.onSwipeThreeFingerDown();
   +                    // &&}}
                        }
                    }
                    break;
   +
                case MotionEvent.ACTION_HOVER_MOVE:
                    if (event.isFromSource(InputDevice.SOURCE_MOUSE)) {
                        if (!mMouseHoveringAtEdge && event.getY() == 0) {
   @@ -224,6 +264,22 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
                        }
                    }
                    break;
   +            // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +            case MotionEvent.ACTION_POINTER_UP:
   +                if (event.getPointerCount() == 4) {
   +                    mPointer1Id = event.getPointerId(0);
   +                    mPointer2Id = event.getPointerId(1);
   +                    mPointer3Id = event.getPointerId(2);
   +                    mDown1Y = event.getY(0);
   +                    mDown2Y = event.getY(1);
   +                    mDown3Y = event.getY(2);
   +                } else {
   +                    if (isScreenshot) {
   +                        isScreenshot = false;
   +                    }
   +                }
   +                break;
   +            // &&}}
                case MotionEvent.ACTION_UP:
                case MotionEvent.ACTION_CANCEL:
                    mSwipeFireable = false;
   @@ -235,6 +291,17 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
            }
        }
    
   +    // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +    private float getPointerY(MotionEvent event, int pointerId) {
   +        for (int i = 0; i < event.getPointerCount(); i++) {
   +            if (event.getPointerId(i) == pointerId) {
   +                return event.getY(i);
   +            }
   +        }
   +        return -1;
   +    }
   +    // &&}}
   +
        private void captureDown(MotionEvent event, int pointerIndex) {
            final int pointerId = event.getPointerId(pointerIndex);
            final int i = findIndex(pointerId);
   @@ -370,6 +437,7 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
            void onSwipeFromBottom();
            void onSwipeFromRight();
            void onSwipeFromLeft();
   +        void onSwipeThreeFingerDown(); // Add Smart gesture menu by qty at 2023-02-28
            void onFling(int durationMs);
            void onDown();
            void onUpOrCancel();
   (END)
   ```

2. 修改 `frameworks/base/services/core/java/com/android/server/wm/DisplayPolicy.java` 文件如下代码：

   > 提示：实现截屏动作。

   ```diff
   @@ -481,6 +505,14 @@ public class DisplayPolicy {
                            }
                            excludedRegion.recycle();
                        }
   +                    
   +                    // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +                    @Override
   +                    public void onSwipeThreeFingerDown() {
   +                        takeScreenshot(android.view.WindowManager.TAKE_SCREENSHOT_FULLSCREEN,
   +                            android.view.WindowManager.ScreenshotSource.SCREENSHOT_KEY_CHORD);
   +                    }
   +                    // &&}}
    
                        private void requestTransientBarsForSideSwipe(Region excludedRegion,
                                int navBarSide, int altBarSide) {
   ```
   
3. 修改 `frameworks/base/core/java/android/view/ViewGroup.java` 文件如下代码：

   > 提示：在 `onInterceptTouchEvent()` 方法中屏蔽触摸下发。

   ```diff
   @@ -3349,6 +3349,12 @@ public abstract class ViewGroup extends View implements ViewParent, ViewManager
                    && isOnScrollbarThumb(ev.getX(), ev.getY())) {
                return true;
            }
   +        // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +        if (ev.getPointerCount() == 3) {
   +            boolean enabled = android.provider.Settings.System.getInt(getContext().getContentResolver(), "st_screen_shot", 0) == 1;
   +            return enabled;
   +        }
   +        // &&}}
            return false;
        }
    
   ```
   
   