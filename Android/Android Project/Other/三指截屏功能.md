> 注意：下面修改代码不包括控制菜单，需要自行添加。

1. 修改 `frameworks/base/services/core/java/com/android/server/wm/SystemGesturesPointerEventListener.java` 文件如下代码：

   > 提示：添加下滑手势，在下滑手势中判断当前触摸手指数来出发截屏操作。

   ```diff
   @@ -58,6 +58,7 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
        private static final int SWIPE_FROM_BOTTOM = 2;
        private static final int SWIPE_FROM_RIGHT = 3;
        private static final int SWIPE_FROM_LEFT = 4;
   +    private static final int SWIPE_DOWN = 5; // Add Smart gesture menu by qty at 2023-02-28
    
        private final Context mContext;
        private final Handler mHandler;
   @@ -193,7 +194,8 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
                case MotionEvent.ACTION_MOVE:
                    if (mSwipeFireable) {
                        final int swipe = detectSwipe(event);
   -                    mSwipeFireable = swipe == SWIPE_NONE;
   +                                       // android.util.Log.d("qty", "[SystemGesturesPointerEventListener]onPointerEvent=>swipe: " + swipe);
   +                    mSwipeFireable = (swipe == SWIPE_NONE) || (swipe == SWIPE_FROM_TOP);
                        if (swipe == SWIPE_FROM_TOP) {
                            if (DEBUG) Slog.d(TAG, "Firing onSwipeFromTop");
                            mCallbacks.onSwipeFromTop();
   @@ -207,6 +209,12 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
                            if (DEBUG) Slog.d(TAG, "Firing onSwipeFromLeft");
                            mCallbacks.onSwipeFromLeft();
                        }
   +                    // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +                    else if (swipe == SWIPE_DOWN) {
   +                                               // android.util.Log.d("qty", "[SystemGesturesPointerEventListener]onPointerEvent=>SWIPE_DOWN");
   +                                               mCallbacks.onSwipeThreeFingerDown();
   +                                       }
   +                                       // &&}}
                    }
                    break;
                case MotionEvent.ACTION_HOVER_MOVE:
   @@ -277,12 +285,12 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
                        final long time = move.getHistoricalEventTime(h);
                        final float x = move.getHistoricalX(p, h);
                        final float y = move.getHistoricalY(p,  h);
   -                    final int swipe = detectSwipe(i, time, x, y);
   +                    final int swipe = detectSwipe(pointerCount, i, time, x, y);
                        if (swipe != SWIPE_NONE) {
                            return swipe;
                        }
                    }
   -                final int swipe = detectSwipe(i, move.getEventTime(), move.getX(p), move.getY(p));
   +                final int swipe = detectSwipe(pointerCount, i, move.getEventTime(), move.getX(p), move.getY(p));
                    if (swipe != SWIPE_NONE) {
                        return swipe;
                    }
   @@ -291,16 +299,42 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
            return SWIPE_NONE;
        }
    
   -    private int detectSwipe(int i, long time, float x, float y) {
   +    private int detectSwipe(int pointerCount, int i, long time, float x, float y) {
            final float fromX = mDownX[i];
            final float fromY = mDownY[i];
            final long elapsed = time - mDownTime[i];
            if (DEBUG) Slog.d(TAG, "pointer " + mDownPointerId[i]
                    + " moved (" + fromX + "->" + x + "," + fromY + "->" + y + ") in " + elapsed);
   +               // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +               /*
            if (fromY <= mSwipeStartThreshold.top
                    && y > fromY + mSwipeDistanceThreshold
                    && elapsed < SWIPE_TIMEOUT_MS) {
   -            return SWIPE_FROM_TOP;
   +                       return SWIPE_FROM_TOP;
   +               }
   +               */
   +               if (y > fromY + mSwipeDistanceThreshold
   +                && elapsed < SWIPE_TIMEOUT_MS) {
   +                       // android.util.Log.d("qty", "[SystemGesturesPointerEventListener]detectSwipe=>pointerCount: " + pointerCount);
   +                       if (pointerCount == 3) {
   +                               boolean enabled = android.provider.Settings.System.getInt(mContext.getContentResolver(), "st_screen_shot", 0) == 1;
   +                               // android.util.Log.d("qty", "[SystemGesturesPointerEventListener]detectSwipe=>enabled: " + enabled);
   +                               if (enabled) {
   +                                       // android.util.Log.d("qty", "[SystemGesturesPointerEventListener]detectSwipe=>y: " + y + ", fromY: " + fromY);
   +                                       if (y > fromY + 100) {
   +                                               return SWIPE_DOWN;
   +                                       } 
   +                               } else {
   +                                       if (fromY <= mSwipeStartThreshold.top) {
   +                                               return SWIPE_FROM_TOP;
   +                                       }
   +                               }
   +                       } else {
   +                               if (fromY <= mSwipeStartThreshold.top) {
   +                                       return SWIPE_FROM_TOP;
   +                               }
   +                       }
   +            // &&}}
            }
            if (fromY >= screenHeight - mSwipeStartThreshold.bottom
                    && y < fromY - mSwipeDistanceThreshold
   @@ -370,6 +404,7 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
            void onSwipeFromBottom();
            void onSwipeFromRight();
            void onSwipeFromLeft();
   +        void onSwipeThreeFingerDown(); // Add Smart gesture menu by qty at 2023-02-28
            void onFling(int durationMs);
            void onDown();
            void onUpOrCancel();
   ```

2. 修改 `frameworks/base/services/core/java/com/android/server/wm/DisplayPolicy.java` 文件如下代码：

   > 提示：实现截屏动作。

   ```diff
   @@ -481,6 +505,14 @@ public class DisplayPolicy {
                            }
                            excludedRegion.recycle();
                        }
   +                    
   +                    // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +                    @Override
   +                    public void onSwipeThreeFingerDown() {
   +                                               takeScreenshot(android.view.WindowManager.TAKE_SCREENSHOT_FULLSCREEN,
   +                                                       android.view.WindowManager.ScreenshotSource.SCREENSHOT_KEY_CHORD);
   +                                       }
   +                                       // &&}}
    
                        private void requestTransientBarsForSideSwipe(Region excludedRegion,
                                int navBarSide, int altBarSide) {
   ```
   
3. 修改 `frameworks/base/core/java/android/view/ViewGroup.java` 文件如下代码：

   > 提示：在 `onInterceptTouchEvent()` 方法中屏蔽触摸下发。

   ```diff
   @@ -3349,6 +3349,13 @@ public abstract class ViewGroup extends View implements ViewParent, ViewManager
                    && isOnScrollbarThumb(ev.getX(), ev.getY())) {
                return true;
            }
   +               // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +               if (ev.getPointerCount() == 3) {
   +                       boolean enabled = android.provider.Settings.System.getInt(getContext().getContentResolver(), "st_screen_shot", 0) == 1;
   +                       // android.util.Log.d("ViewGroup", "onInterceptTouchEvent=>enabled: " + enabled);
   +                       return enabled;
   +               }
   +               // &&}}
            return false;
        }
   ```
   
   