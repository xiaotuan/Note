> 注意：下面修改代码不包括控制菜单，需要自行添加。

1. 修改 `frameworks/base/services/core/java/com/android/server/wm/SystemGesturesPointerEventListener.java` 文件如下代码：

   > 提示：添加下滑手势，在下滑手势中判断当前触摸手指数来出发截屏操作。

   ```diff
   diff --git a/frameworks/base/services/core/java/com/android/server/wm/SystemGesturesPointerEventListener.java b/frameworks/base/services/core/java/com/android/server/wm/SystemGesturesPointerEventListener.java
   index 658f4efbdb2..dd1f33c2bc3 100644
   --- a/frameworks/base/services/core/java/com/android/server/wm/SystemGesturesPointerEventListener.java
   +++ b/frameworks/base/services/core/java/com/android/server/wm/SystemGesturesPointerEventListener.java
   @@ -58,6 +58,7 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
        private static final int SWIPE_FROM_BOTTOM = 2;
        private static final int SWIPE_FROM_RIGHT = 3;
        private static final int SWIPE_FROM_LEFT = 4;
   +    private static final int SWIPE_DOWN = 5; // Add Smart gesture menu by qty at 2023-02-28
    
        private final Context mContext;
        private final Handler mHandler;
   @@ -207,6 +208,14 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
                            if (DEBUG) Slog.d(TAG, "Firing onSwipeFromLeft");
                            mCallbacks.onSwipeFromLeft();
                        }
   +                    // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +                    else if (swipe == SWIPE_DOWN) {
   +                                               android.util.Log.d("Sgpel", "Firing onSwipeThreeFingerDown");
   +                                               if (event.getPointerCount() >=3) {
   +                                                       mCallbacks.onSwipeThreeFingerDown();
   +                                               }
   +                                       }
   +                                       // &&}}
                    }
                    break;
                case MotionEvent.ACTION_HOVER_MOVE:
   @@ -302,6 +311,12 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
                    && elapsed < SWIPE_TIMEOUT_MS) {
                return SWIPE_FROM_TOP;
            }
   +        // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +        else if (y > fromY + 150
   +                       && elapsed < SWIPE_TIMEOUT_MS) {
   +                       return SWIPE_DOWN;
   +               }
   +        // &&}}
            if (fromY >= screenHeight - mSwipeStartThreshold.bottom
                    && y < fromY - mSwipeDistanceThreshold
                    && elapsed < SWIPE_TIMEOUT_MS) {
   @@ -370,6 +385,7 @@ class SystemGesturesPointerEventListener implements PointerEventListener {
            void onSwipeFromBottom();
            void onSwipeFromRight();
            void onSwipeFromLeft();
   +        void onSwipeThreeFingerDown(); // Add Smart gesture menu by qty at 2023-02-28
            void onFling(int durationMs);
            void onDown();
            void onUpOrCancel();
   ```

2. 修改 `frameworks/base/services/core/java/com/android/server/wm/DisplayPolicy.java` 文件如下代码：

   > 提示：实现截屏动作。

   ```diff
   diff --git a/frameworks/base/services/core/java/com/android/server/wm/DisplayPolicy.java b/frameworks/base/services/core/java/com/android/server/wm/DisplayPolicy.java
   index 6b493c112d6..5d7758f0ec5 100644
   --- a/frameworks/base/services/core/java/com/android/server/wm/DisplayPolicy.java
   +++ b/frameworks/base/services/core/java/com/android/server/wm/DisplayPolicy.java
   @@ -481,6 +481,18 @@ public class DisplayPolicy {
                            }
                            excludedRegion.recycle();
                        }
   +                    
   +                    // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +                    @Override
   +                    public void onSwipeThreeFingerDown() {
   +                                               boolean enabled = android.provider.Settings.System.getInt(mContext.getContentResolver(), "st_screen_shot", 0) == 1;
   +                                               android.util.Log.d("DisplayPolicy", "onSwipeThreeFingerDown=>enabled: " + enabled);
   +                                               if (enabled) {
   +                                                       takeScreenshot(android.view.WindowManager.TAKE_SCREENSHOT_FULLSCREEN,
   +                                                               android.view.WindowManager.ScreenshotSource.SCREENSHOT_KEY_CHORD);
   +                                               }
   +                                       }
   +                                       // &&}}
    
                        private void requestTransientBarsForSideSwipe(Region excludedRegion,
                                int navBarSide, int altBarSide) {
   ```

3. 修改 `frameworks/base/core/java/android/view/ViewGroup.java` 文件如下代码：

   > 提示：在 `onInterceptTouchEvent()` 方法中屏蔽触摸下发。

   ```diff
   diff --git a/frameworks/base/core/java/android/view/ViewGroup.java b/frameworks/base/core/java/android/view/ViewGroup.java
   index 6f8dc2dafda..d4b19e16022 100644
   --- a/frameworks/base/core/java/android/view/ViewGroup.java
   +++ b/frameworks/base/core/java/android/view/ViewGroup.java
   @@ -3349,6 +3349,13 @@ public abstract class ViewGroup extends View implements ViewParent, ViewManager
                    && isOnScrollbarThumb(ev.getX(), ev.getY())) {
                return true;
            }
   +               // Add Smart gesture menu by qty at 2023-02-28 {{&&
   +               if (ev.getPointerCount() >= 3) {
   +                       boolean enabled = android.provider.Settings.System.getInt(getContext().getContentResolver(), "st_screen_shot", 0) == 1;
   +                       android.util.Log.d("ViewGroup", "onInterceptTouchEvent=>enabled: " + enabled);
   +                       return enabled;
   +               }
   +               // &&}}
            return false;
        }
    
   ```

   