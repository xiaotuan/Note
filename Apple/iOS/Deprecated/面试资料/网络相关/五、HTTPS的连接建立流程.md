###### 五、HTTPS的连接建立流程

HTTPS为了兼顾安全与效率，同时使用了对称加密和非对称加密。在传输的过程中会涉及到三个密钥：

- 服务器端的公钥和私钥，用来进行`非对称加密`

- 客户端生成的随机密钥，用来进行`对称加密`

**1、客户端访问HTTPS连接。**

客户端会把`安全协议版本号`、客户端支持的加密算法列表、`随机数C`发给服务端。

**2、服务端发送证书给客户端**

服务端接收密钥算法配件后，会和自己支持的加密算法列表进行比对，如果不符合，则断开连接。否则，服务端会在该算法列表中，选择一种对称算法（如AES）、一种公钥算法（如具有特定秘钥长度的RSA）和一种MAC算法发给客户端。
服务器端有一个密钥对，即`公钥`和`私钥`，是用来进行`非对称加密`使用的，服务器端保存着`私钥`，不能将其泄露，`公钥`可以发送给任何人。
在发送加密算法的同时还会把`数字证书`和`随机数S`发送给客户端

**3、客户端验证server证书**

会对server公钥进行检查，验证其合法性，如果发现发现公钥有问题，那么HTTPS传输就无法继续。

**4、客户端组装会话秘钥**

如果公钥合格，那么客户端会用服务器公钥来生成一个`前主秘钥`(Pre-Master Secret，PMS)，并通过该`前主秘钥`和随机数C、S来组装成`会话秘钥`

**5、客户端将前主秘钥加密发送给服务端**

是通过服务端的公钥来对前主秘钥进行非对称加密，发送给服务端

**6、服务端通过私钥解密得到前主秘钥**

服务端接收到加密信息后，用私钥解密得到主秘钥。

**7、服务端组装会话秘钥**

服务端通过`前主秘钥`和随机数C、S来组装`会话秘钥`。
至此，服务端和客户端都已经知道了用于此次会话的主秘钥。

**8、数据传输**

客户端收到服务器发送来的密文，用客户端密钥对其进行对称解密，得到服务器发送的数据。
同理，服务端收到客户端发送来的密文，用服务端密钥对其进行对称解密，得到客户端发送的数据。

**总结：**

`会话秘钥` = random S + random C + `前主秘钥`

- HTTPS连接建立过程使用`非对称加密`，而`非对称加密`是很耗时的一种加密方式

- 后续通信过程使用`对称加密`，减少耗时所带来的性能损耗

- 其中，`对称加密`加密的是实际的数据，`非对称加密`加密的是对称加密所需要的客户端的密钥。